# 效能瓶頸分析與優化建議

## 1. 效能瓶頸的根本原因

### 主要瓶頸：Google Sheets 作為資料庫的先天限制

#### A. Google Sheets 的效能限制

**1. 讀取效能問題**
```
當前操作：sheet.getDataRange().getValues()
- 每次讀取都是「全表掃描」
- 即使只需要 1 筆資料，也要載入整個工作表
- 沒有索引機制，無法快速定位特定資料
```

**效能影響：**
- 2 筆資料：讀取時間 ~0.5-1 秒
- 100 筆資料：讀取時間 ~2-5 秒
- 1000 筆資料：讀取時間 ~10-30 秒
- 10000 筆資料：讀取時間 ~60-120 秒（可能超時）

**2. Google Apps Script 執行限制**
```
- 最大執行時間：6 分鐘
- 每日執行配額：20,000 次
- 每次讀寫都是網路請求（非本地操作）
- 需要經過 Google 的伺服器處理
```

**3. 網路延遲**
```
前端 → Google Apps Script → Google Sheets API → 返回結果
每個步驟都有網路延遲（通常 100-500ms）
```

**4. 資料格式限制**
```
- 所有資料都是字串格式（需要轉換）
- 沒有資料類型驗證
- 沒有外鍵約束
- 沒有事務處理
```

### B. 當前架構的效能瓶頸點

**瓶頸 1：全表讀取**
```javascript
// 每次都要讀取整個工作表
const data = sheet.getDataRange().getValues(); // 讀取所有資料
```

**瓶頸 2：重複讀取**
```javascript
// 載入行程時
getAllSchedules() → 讀取行程表 + 讀取客戶表
getAllOrders() → 讀取訂單表 + 讀取客戶表
// 客戶表被重複讀取多次
```

**瓶頸 3：資料處理**
```javascript
// 在 Google Apps Script 中處理大量資料
for (let i = 1; i < data.length; i++) {
    // 複雜的資料格式轉換
}
```

**瓶頸 4：網路往返**
```
每次 API 調用 = 前端請求 + Google Apps Script 處理 + Google Sheets 讀寫 + 返回結果
總延遲：200-1000ms（取決於資料量）
```

## 2. 改用資料庫的效能提升

### A. 傳統資料庫（MySQL/PostgreSQL）vs Google Sheets

| 項目 | Google Sheets | 資料庫 | 效能差異 |
|------|--------------|--------|---------|
| **讀取單筆資料** | 全表掃描（1-5秒） | 索引查詢（<10ms） | **100-500倍** |
| **讀取100筆資料** | 全表掃描（2-5秒） | 索引查詢（<50ms） | **40-100倍** |
| **讀取1000筆資料** | 全表掃描（10-30秒） | 索引查詢（<200ms） | **50-150倍** |
| **寫入操作** | 逐行寫入（1-3秒） | 批量寫入（<100ms） | **10-30倍** |
| **並發處理** | 有限（共享試算表） | 優秀（事務鎖） | **10-100倍** |
| **查詢複雜度** | 簡單（僅全表掃描） | 複雜（SQL查詢） | **無限** |

### B. 雲端資料庫選項

#### 1. Firebase Firestore（推薦）
```javascript
// 效能提升：10-50 倍
// 優勢：
- 即時同步
- 自動索引
- 離線支援
- 免費額度充足

// 讀取速度：
- 1 筆：< 50ms
- 100 筆：< 200ms
- 1000 筆：< 500ms
```

#### 2. Google Cloud SQL（MySQL/PostgreSQL）
```javascript
// 效能提升：50-200 倍
// 優勢：
- 標準 SQL
- 完整索引
- 事務支援
- 高可用性

// 讀取速度：
- 1 筆：< 10ms
- 100 筆：< 50ms
- 1000 筆：< 200ms
```

#### 3. Supabase（PostgreSQL）
```javascript
// 效能提升：50-200 倍
// 優勢：
- 開源 PostgreSQL
- 即時 API
- 免費額度
- 簡單易用

// 讀取速度：
- 1 筆：< 20ms
- 100 筆：< 100ms
- 1000 筆：< 300ms
```

## 3. 效能提升預估

### 小量資料（2-10 筆）
```
Google Sheets: 1-3 秒
資料庫: 50-200ms
提升：5-10 倍
```

### 中量資料（50-100 筆）
```
Google Sheets: 5-15 秒
資料庫: 100-500ms
提升：10-30 倍
```

### 大量資料（500-1000 筆）
```
Google Sheets: 30-120 秒
資料庫: 200-1000ms
提升：30-120 倍
```

### 超大資料（10000+ 筆）
```
Google Sheets: 可能超時或失敗
資料庫: 500-2000ms
提升：幾乎無限
```

## 4. 遷移建議

### 階段性遷移方案

#### 階段 1：保持現有架構 + 優化
- ✅ 已完成：快取機制、並行載入
- 預期提升：50-60%
- 適用：資料量 < 500 筆

#### 階段 2：混合架構
- 讀取：使用資料庫（快速）
- 備份：定期同步到 Google Sheets（備份/報表）
- 預期提升：10-50 倍

#### 階段 3：完全遷移
- 所有操作使用資料庫
- Google Sheets 僅作為報表工具
- 預期提升：50-200 倍

## 5. 成本比較

### Google Sheets（免費）
- 成本：$0
- 限制：執行配額、資料量限制
- 效能：低-中

### Firebase Firestore
- 成本：免費額度（每天 50,000 次讀取）
- 付費：$0.06/10萬次讀取
- 效能：高

### Supabase
- 成本：免費額度（500MB 資料庫）
- 付費：$25/月（8GB）
- 效能：高

## 6. 建議

### 立即行動（短期）
1. ✅ 保持現有優化（快取、並行）
2. 監控資料量成長
3. 設定資料量上限（建議 500 筆）

### 中期規劃（3-6 個月）
1. 評估資料量是否超過 500 筆
2. 如果超過，考慮遷移到 Firebase Firestore
3. 保持 Google Sheets 作為備份

### 長期規劃（6-12 個月）
1. 如果資料量持續成長，完全遷移到資料庫
2. 使用 Google Sheets 僅作為報表工具

