<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ¶è³‡æ–™</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="js/taiwan-address.js"></script>
</head>
<body>
    <!-- å´é‚Šå°èˆªæ¬„ -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>é¸å–®</h2>
            <button class="close-btn" onclick="toggleSidebar()">Ã—</button>
        </div>
        <nav class="sidebar-nav">
            <a href="add-customer.html" class="nav-item">
                <span class="nav-icon">â•</span>
                <span>æ–°å¢å®¢æˆ¶</span>
            </a>
            <a href="calendar.html" class="nav-item">
                <span class="nav-icon">ğŸ“…</span>
                <span>è¡Œç¨‹äº‹é …</span>
            </a>
            <a href="customers.html" class="nav-item active">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>å®¢æˆ¶è³‡æ–™</span>
            </a>
            <a href="orders.html" class="nav-item">
                <span class="nav-icon">ğŸ“¦</span>
                <span>è¨‚è²¨æ¸…å–®</span>
            </a>
            <div class="nav-divider"></div>
            <a href="#" class="nav-item" onclick="logout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ç™»å‡º</span>
            </a>
        </nav>
    </div>

    <!-- å´é‚Šæ¬„é®ç½© -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-content">
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="header">
            <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
            <h1>å®¢æˆ¶è³‡æ–™</h1>
            <div class="header-actions">
                <a href="add-customer.html" class="btn btn-primary">æ–°å¢å®¢æˆ¶</a>
            </div>
        </header>

        <!-- å®¢æˆ¶åˆ—è¡¨ -->
        <div class="container">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="æœå°‹å®¢æˆ¶å§“åæˆ–é›»è©±..." onkeyup="filterCustomers()">
            </div>

            <div class="customer-list-container" id="customerList">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <script src="js/script.js"></script>
    <script src="js/taiwan-address.js"></script>
    <script>
        let allCustomers = [];
        let currentDisplayCustomers = []; // ç•¶å‰é¡¯ç¤ºçš„å®¢æˆ¶åˆ—è¡¨
        let expandedCustomers = new Set(); // è¿½è¹¤å·²å±•é–‹çš„å®¢æˆ¶
        let editingCustomers = new Set(); // è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„å®¢æˆ¶

        async function loadCustomerList() {
            const listContainer = document.getElementById('customerList');
            showLoading(listContainer);

            try {
                allCustomers = await getCustomers();
                currentDisplayCustomers = allCustomers;
                
                // ç¢ºä¿æ‰€æœ‰å®¢æˆ¶ ID éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œä¸¦åˆå§‹åŒ– expandedCustomers
                allCustomers.forEach(customer => {
                    if (customer.id) {
                        customer.id = String(customer.id);
                    }
                });
                
                if (allCustomers.length === 0) {
                    listContainer.innerHTML = '<div class="empty-message">å°šç„¡å®¢æˆ¶è³‡æ–™</div>';
                    return;
                }

                console.log('Loaded customers:', allCustomers.map(c => ({ id: c.id, name: c.name })));
                displayCustomerList(currentDisplayCustomers);
            } catch (error) {
                showError(listContainer, 'è¼‰å…¥å®¢æˆ¶è³‡æ–™å¤±æ•—ï¼š' + error.message);
                console.error('Load customer list error:', error);
            }
        }

        function displayCustomerList(customers) {
            const listContainer = document.getElementById('customerList');
            
            listContainer.innerHTML = customers.map(customer => {
                // ç¢ºä¿ customer.id è½‰æ›ç‚ºå­—ç¬¦ä¸²
                const customerId = String(customer.id || '');
                const isExpanded = expandedCustomers.has(customerId);
                const isEditing = editingCustomers.has(customerId);
                const healthStatusPreview = customer.healthStatus 
                    ? (customer.healthStatus.length > 50 ? customer.healthStatus.substring(0, 50) + '...' : customer.healthStatus)
                    : 'å°šæœªå¡«å¯«';
                
                // çµ±ä¸€é¡¯ç¤ºæ¨¡å¼ï¼Œä½†æ ¹æ“š isEditing æ±ºå®šæ˜¯å¦å¯ç·¨è¼¯
                const editableClass = isEditing ? 'editable' : '';
                const editButtonText = isEditing ? 'å„²å­˜è³‡æ–™' : 'æ›´æ–°è³‡æ–™';
                const editButtonAction = isEditing ? `saveCustomerEdit('${customerId}', event)` : `startEdit('${customerId}', event)`;
                
                return `
                    <div class="customer-list-item ${isExpanded ? 'expanded' : ''} ${editableClass}" data-customer-id="${customerId}">
                        <div class="customer-list-header" data-customer-id="${customerId}">
                            <div class="customer-list-avatar">
                                ${customer.avatar ? `<img src="${customer.avatar}" alt="${customer.name}">` : '<div class="avatar-placeholder-list">' + (customer.name ? customer.name.charAt(0) : '?') + '</div>'}
                            </div>
                            <div class="customer-list-summary">
                                <h3>${customer.name || 'æœªå‘½å'}</h3>
                                <p class="customer-list-health">${healthStatusPreview}</p>
                            </div>
                            <div class="customer-list-expand-icon">
                                <span class="expand-icon">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                            </div>
                        </div>
                        <div class="customer-list-detail" style="display: ${isExpanded ? 'block' : 'none'};">
                            <div class="customer-detail-content">
                                <div class="detail-row">
                                    <strong>ğŸ“ é›»è©±ï¼š</strong>
                                    ${isEditing ? 
                                        `<input type="tel" class="editable-input" data-field="phone" value="${(customer.phone || '').replace(/"/g, '&quot;')}" required>` :
                                        `<span class="editable-text">${customer.phone || 'æœªæä¾›'}</span>`
                                    }
                                </div>
                                <div class="detail-row">
                                    <strong>ğŸ“ åœ°å€ï¼š</strong>
                                    ${isEditing ? 
                                        `<textarea class="editable-textarea" data-field="fullAddress" rows="2">${(customer.fullAddress || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>` :
                                        `<span class="editable-text">${customer.fullAddress || (customer.city ? (customer.city + (customer.district || '') + (customer.streetName || '') + (customer.streetType || '') + (customer.lane ? customer.lane + 'å··' : '') + (customer.alley ? customer.alley + 'å¼„' : '') + (customer.number ? customer.number + 'è™Ÿ' : '') + (customer.floor || '')) : (customer.region || 'å°šæœªå¡«å¯«'))}</span>`
                                    }
                                </div>
                                <div class="detail-row">
                                    <strong>ğŸ’Š æœç”¨è—¥ç‰©ï¼š</strong>
                                    ${isEditing ? 
                                        `<textarea class="editable-textarea" data-field="medications" rows="3">${(customer.medications || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>` :
                                        `<span class="editable-text">${customer.medications || 'å°šæœªå¡«å¯«'}</span>`
                                    }
                                </div>
                                <div class="detail-row">
                                    <strong>ğŸ æœç”¨ä¿å¥é£Ÿå“ï¼š</strong>
                                    ${isEditing ? 
                                        `<textarea class="editable-textarea" data-field="supplements" rows="3">${(customer.supplements || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>` :
                                        `<span class="editable-text">${customer.supplements || 'å°šæœªå¡«å¯«'}</span>`
                                    }
                                </div>
                                ${customer.healthStatus || isEditing ? `
                                <div class="detail-row">
                                    <strong>ğŸ¥ å¥åº·ç‹€æ³ï¼š</strong>
                                    ${isEditing ? 
                                        `<textarea class="editable-textarea" data-field="healthStatus" rows="4">${(customer.healthStatus || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>` :
                                        `<div class="health-status-full">${customer.healthStatus || ''}</div>`
                                    }
                                </div>
                                ` : ''}
                                <div class="customer-detail-actions">
                                    <button class="btn btn-primary btn-sm" onclick="${editButtonAction}">${editButtonText}</button>
                                    ${isEditing ? `<button class="btn btn-secondary btn-sm" onclick="cancelEdit('${customerId}', event)">å–æ¶ˆ</button>` : ''}
                                    <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customerId}', event)">åˆªé™¤å®¢æˆ¶</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCustomerDetail(customerId) {
            // ç¢ºä¿ customerId æ˜¯å­—ç¬¦ä¸²é¡å‹
            const id = String(customerId);
            console.log('Toggle customer:', id, 'Current expanded:', Array.from(expandedCustomers));
            
            if (expandedCustomers.has(id)) {
                expandedCustomers.delete(id);
            } else {
                expandedCustomers.add(id);
            }
            
            console.log('After toggle, expanded:', Array.from(expandedCustomers));
            displayCustomerList(currentDisplayCustomers);
        }

        function startEdit(customerId, event) {
            if (event) {
                event.stopPropagation(); // é˜»æ­¢è§¸ç™¼å±•é–‹/æ”¶åˆ
            }
            
            const id = String(customerId);
            // ç¢ºä¿å®¢æˆ¶å·²å±•é–‹
            if (!expandedCustomers.has(id)) {
                expandedCustomers.add(id);
            }
            // åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼
            editingCustomers.add(id);
            displayCustomerList(currentDisplayCustomers);
        }

        function cancelEdit(customerId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const id = String(customerId);
            editingCustomers.delete(id);
            displayCustomerList(currentDisplayCustomers);
        }

        async function saveCustomerEdit(customerId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const id = String(customerId);
            const customerItem = document.querySelector(`[data-customer-id="${id}"]`);
            if (!customerItem) {
                alert('æ‰¾ä¸åˆ°å®¢æˆ¶è³‡æ–™');
                return;
            }
            
            // å–å¾—è¡¨å–®è³‡æ–™
            const phoneInput = customerItem.querySelector('[data-field="phone"]');
            const fullAddressInput = customerItem.querySelector('[data-field="fullAddress"]');
            const medicationsInput = customerItem.querySelector('[data-field="medications"]');
            const supplementsInput = customerItem.querySelector('[data-field="supplements"]');
            const healthStatusInput = customerItem.querySelector('[data-field="healthStatus"]');
            
            const customerData = {
                phone: phoneInput ? phoneInput.value.trim() : '',
                fullAddress: fullAddressInput ? fullAddressInput.value.trim() : '',
                medications: medicationsInput ? medicationsInput.value.trim() : '',
                supplements: supplementsInput ? supplementsInput.value.trim() : '',
                healthStatus: healthStatusInput ? healthStatusInput.value.trim() : ''
            };
            
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!customerData.phone) {
                alert('è«‹å¡«å¯«é›»è©±');
                return;
            }
            
            // å¾åŸå§‹å®¢æˆ¶è³‡æ–™ä¸­å–å¾—å…¶ä»–æ¬„ä½ï¼ˆå§“åå’Œåœ°å€ç›¸é—œæ¬„ä½ï¼‰
            const originalCustomer = allCustomers.find(c => String(c.id) === id);
            if (!originalCustomer) {
                alert('æ‰¾ä¸åˆ°å®¢æˆ¶è³‡æ–™');
                return;
            }
            
            customerData.name = originalCustomer.name || '';
            customerData.city = originalCustomer.city || '';
            customerData.district = originalCustomer.district || '';
            customerData.village = originalCustomer.village || '';
            customerData.neighborhood = originalCustomer.neighborhood || '';
            customerData.streetType = originalCustomer.streetType || '';
            customerData.streetName = originalCustomer.streetName || '';
            customerData.lane = originalCustomer.lane || '';
            customerData.alley = originalCustomer.alley || '';
            customerData.number = originalCustomer.number || '';
            customerData.floor = originalCustomer.floor || '';
            customerData.avatar = originalCustomer.avatar || '';
            
            try {
                const saveBtn = customerItem.querySelector('.btn-primary');
                const originalText = saveBtn.textContent;
                saveBtn.disabled = true;
                saveBtn.textContent = 'å„²å­˜ä¸­...';
                
                // æ›´æ–°å®¢æˆ¶è³‡æ–™
                await updateCustomer(id, customerData);
                
                // é€€å‡ºç·¨è¼¯æ¨¡å¼
                editingCustomers.delete(id);
                
                // é‡æ–°è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
                await loadCustomerList();
                
                alert('å®¢æˆ¶è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼');
            } catch (error) {
                alert('æ›´æ–°å®¢æˆ¶å¤±æ•—ï¼š' + error.message);
                console.error('Update customer error:', error);
                const saveBtn = customerItem.querySelector('.btn-primary');
                saveBtn.disabled = false;
                saveBtn.textContent = 'å„²å­˜è³‡æ–™';
            }
        }

        async function deleteCustomer(customerId, event) {
            if (event) {
                event.stopPropagation(); // é˜»æ­¢è§¸ç™¼å±•é–‹/æ”¶åˆ
            }
            
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å®¢æˆ¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }
            
            try {
                const id = String(customerId);
                await deleteCustomerById(id);
                expandedCustomers.delete(id);
                await loadCustomerList();
                alert('å®¢æˆ¶å·²åˆªé™¤');
            } catch (error) {
                alert('åˆªé™¤å®¢æˆ¶å¤±æ•—ï¼š' + error.message);
                console.error('Delete customer error:', error);
            }
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm === '') {
                currentDisplayCustomers = allCustomers;
            } else {
                currentDisplayCustomers = allCustomers.filter(customer => 
                    (customer.name && customer.name.toLowerCase().includes(searchTerm)) ||
                    (customer.phone && customer.phone.includes(searchTerm))
                );
                
                // ä¿ç•™å·²å±•é–‹çš„å®¢æˆ¶ç‹€æ…‹ï¼ˆåªä¿ç•™åœ¨éæ¿¾çµæœä¸­çš„ï¼‰
                const filteredExpanded = new Set(
                    currentDisplayCustomers
                        .filter(c => {
                            const id = String(c.id || '');
                            return expandedCustomers.has(id);
                        })
                        .map(c => String(c.id || ''))
                );
                expandedCustomers = filteredExpanded;
            }
            
            displayCustomerList(currentDisplayCustomers);
        }

        // ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†é»æ“Šäº‹ä»¶
        document.addEventListener('click', function(event) {
            // æª¢æŸ¥æ˜¯å¦é»æ“Šåœ¨åˆªé™¤æŒ‰éˆ•ä¸Šï¼Œå¦‚æœæ˜¯å‰‡ä¸è§¸ç™¼å±•é–‹
            if (event.target.closest('.customer-detail-actions')) {
                return;
            }
            
            const header = event.target.closest('.customer-list-header');
            if (header) {
                const customerId = header.getAttribute('data-customer-id');
                if (customerId) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('Header clicked, customerId:', customerId);
                    toggleCustomerDetail(customerId);
                }
            }
        });

        window.addEventListener('DOMContentLoaded', async function() {
            checkAuth();
            initCitySelect();
            await loadCustomerList();
        });
    </script>
</body>
</html>

