<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ¶è³‡æ–™</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="js/taiwan-address.js"></script>
</head>
<body>
    <!-- å´é‚Šå°èˆªæ¬„ -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>é¸å–®</h2>
            <button class="close-btn" onclick="toggleSidebar()">Ã—</button>
        </div>
        <nav class="sidebar-nav">
            <a href="add-customer.html" class="nav-item">
                <span class="nav-icon">â•</span>
                <span>æ–°å¢å®¢æˆ¶</span>
            </a>
            <a href="calendar.html" class="nav-item">
                <span class="nav-icon">ğŸ“…</span>
                <span>è¡Œç¨‹äº‹é …</span>
            </a>
            <a href="customers.html" class="nav-item active">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>å®¢æˆ¶è³‡æ–™</span>
            </a>
            <a href="orders.html" class="nav-item">
                <span class="nav-icon">ğŸ“¦</span>
                <span>è¨‚è²¨æ¸…å–®</span>
            </a>
            <div class="nav-divider"></div>
            <a href="#" class="nav-item" onclick="logout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ç™»å‡º</span>
            </a>
        </nav>
    </div>

    <!-- å´é‚Šæ¬„é®ç½© -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-content">
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="header">
            <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
            <h1>å®¢æˆ¶è³‡æ–™</h1>
            <div class="header-actions">
                <a href="add-customer.html" class="btn btn-primary">æ–°å¢å®¢æˆ¶</a>
            </div>
        </header>

        <!-- å®¢æˆ¶åˆ—è¡¨ -->
        <div class="container">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="æœå°‹å®¢æˆ¶å§“åæˆ–é›»è©±..." onkeyup="filterCustomers()">
            </div>

            <div class="customer-list-container" id="customerList">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <script src="js/script.js"></script>
    <script>
        let allCustomers = [];
        let currentDisplayCustomers = []; // ç•¶å‰é¡¯ç¤ºçš„å®¢æˆ¶åˆ—è¡¨
        let expandedCustomers = new Set(); // è¿½è¹¤å·²å±•é–‹çš„å®¢æˆ¶

        async function loadCustomerList() {
            const listContainer = document.getElementById('customerList');
            showLoading(listContainer);

            try {
                allCustomers = await getCustomers();
                currentDisplayCustomers = allCustomers;
                
                if (allCustomers.length === 0) {
                    listContainer.innerHTML = '<div class="empty-message">å°šç„¡å®¢æˆ¶è³‡æ–™</div>';
                    return;
                }

                displayCustomerList(currentDisplayCustomers);
            } catch (error) {
                showError(listContainer, 'è¼‰å…¥å®¢æˆ¶è³‡æ–™å¤±æ•—ï¼š' + error.message);
            }
        }

        function displayCustomerList(customers) {
            const listContainer = document.getElementById('customerList');
            
            listContainer.innerHTML = customers.map(customer => {
                const isExpanded = expandedCustomers.has(customer.id);
                const healthStatusPreview = customer.healthStatus 
                    ? (customer.healthStatus.length > 50 ? customer.healthStatus.substring(0, 50) + '...' : customer.healthStatus)
                    : 'å°šæœªå¡«å¯«';
                
                return `
                    <div class="customer-list-item ${isExpanded ? 'expanded' : ''}" data-customer-id="${customer.id}">
                        <div class="customer-list-header" data-customer-id="${customer.id}">
                            <div class="customer-list-avatar">
                                ${customer.avatar ? `<img src="${customer.avatar}" alt="${customer.name}">` : '<div class="avatar-placeholder-list">' + (customer.name ? customer.name.charAt(0) : '?') + '</div>'}
                            </div>
                            <div class="customer-list-summary">
                                <h3>${customer.name || 'æœªå‘½å'}</h3>
                                <p class="customer-list-health">${healthStatusPreview}</p>
                            </div>
                            <div class="customer-list-expand-icon">
                                <span class="expand-icon">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                            </div>
                        </div>
                        <div class="customer-list-detail" style="display: ${isExpanded ? 'block' : 'none'};">
                            <div class="customer-detail-content">
                                <div class="detail-row">
                                    <strong>ğŸ“ é›»è©±ï¼š</strong>${customer.phone || 'æœªæä¾›'}
                                </div>
                                <div class="detail-row">
                                    <strong>ğŸ“ åœ°å€ï¼š</strong>${customer.fullAddress || (customer.city ? (customer.city + (customer.district || '') + (customer.streetName || '') + (customer.streetType || '') + (customer.lane ? customer.lane + 'å··' : '') + (customer.alley ? customer.alley + 'å¼„' : '') + (customer.number ? customer.number + 'è™Ÿ' : '') + (customer.floor || '')) : (customer.region || 'å°šæœªå¡«å¯«'))}
                                </div>
                                <div class="detail-row">
                                    <strong>ğŸ’Š æœç”¨è—¥ç‰©ï¼š</strong>${customer.medications || 'å°šæœªå¡«å¯«'}
                                </div>
                                <div class="detail-row">
                                    <strong>ğŸ æœç”¨ä¿å¥é£Ÿå“ï¼š</strong>${customer.supplements || 'å°šæœªå¡«å¯«'}
                                </div>
                                ${customer.healthStatus ? `
                                <div class="detail-row">
                                    <strong>ğŸ¥ å¥åº·ç‹€æ³ï¼š</strong>
                                    <div class="health-status-full">${customer.healthStatus}</div>
                                </div>
                                ` : ''}
                                <div class="customer-detail-actions">
                                    <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer.id}', event)">åˆªé™¤å®¢æˆ¶</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCustomerDetail(customerId) {
            if (expandedCustomers.has(customerId)) {
                expandedCustomers.delete(customerId);
            } else {
                expandedCustomers.add(customerId);
            }
            displayCustomerList(currentDisplayCustomers);
        }

        async function deleteCustomer(customerId, event) {
            event.stopPropagation(); // é˜»æ­¢è§¸ç™¼å±•é–‹/æ”¶åˆ
            
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å®¢æˆ¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }
            
            try {
                await deleteCustomerById(customerId);
                expandedCustomers.delete(customerId);
                await loadCustomerList();
                alert('å®¢æˆ¶å·²åˆªé™¤');
            } catch (error) {
                alert('åˆªé™¤å®¢æˆ¶å¤±æ•—ï¼š' + error.message);
            }
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm === '') {
                currentDisplayCustomers = allCustomers;
            } else {
                currentDisplayCustomers = allCustomers.filter(customer => 
                    (customer.name && customer.name.toLowerCase().includes(searchTerm)) ||
                    (customer.phone && customer.phone.includes(searchTerm))
                );
                
                // ä¿ç•™å·²å±•é–‹çš„å®¢æˆ¶ç‹€æ…‹ï¼ˆåªä¿ç•™åœ¨éæ¿¾çµæœä¸­çš„ï¼‰
                const filteredExpanded = new Set(
                    currentDisplayCustomers.filter(c => expandedCustomers.has(c.id)).map(c => c.id)
                );
                expandedCustomers = filteredExpanded;
            }
            
            displayCustomerList(currentDisplayCustomers);
        }

        // ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†é»æ“Šäº‹ä»¶
        document.addEventListener('click', function(event) {
            const header = event.target.closest('.customer-list-header');
            if (header) {
                const customerId = header.getAttribute('data-customer-id');
                if (customerId) {
                    event.preventDefault();
                    event.stopPropagation();
                    toggleCustomerDetail(customerId);
                }
            }
        });

        window.addEventListener('DOMContentLoaded', async function() {
            checkAuth();
            await loadCustomerList();
        });
    </script>
</body>
</html>

