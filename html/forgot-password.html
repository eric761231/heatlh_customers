<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>忘記密碼</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body class="login-page">
    <div class="login-header">
        <button class="back-btn" onclick="window.location.href='login.html'">
            <span>←</span> 返回
        </button>
        <h1 class="welcome-title">重設密碼</h1>
    </div>
    
    <div class="login-content-card">
        <h2 class="login-title">忘記密碼</h2>
        
        <div id="status" class="login-status"></div>
        
        <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
            <div class="form-group-modern">
                <input type="email" id="email" name="email" required placeholder="Your email" autocomplete="email" class="modern-input">
            </div>
            
            <button type="submit" class="btn-login-gradient">
                發送重置郵件
            </button>
        </form>
        
        <div class="signup-link">
            <span>記起密碼了？</span>
            <a href="login.html">返回登入</a>
        </div>
    </div>

    <script>
        // 處理忘記密碼請求
        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const statusDiv = document.getElementById('status');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // 獲取表單資料
            const email = document.getElementById('email').value.trim();
            
            // 驗證
            if (!email) {
                statusDiv.innerHTML = '<div class="error-message">請輸入您的 Email</div>';
                return;
            }
            
            // 初始化 Supabase
            const client = initSupabase();
            if (!client) {
                statusDiv.innerHTML = '<div class="error-message">系統初始化失敗，請重新整理頁面</div>';
                return;
            }
            
            // 顯示載入狀態
            submitBtn.disabled = true;
            submitBtn.textContent = '發送中...';
            statusDiv.innerHTML = '<div style="color: #6B7280; padding: 12px; text-align: center;">正在發送重置郵件，請稍候...</div>';
            
            try {
                // 發送密碼重置郵件
                // 構建重置密碼頁面的完整 URL
                // 使用 window.location.origin 會自動適應環境（本地開發或 Netlify 部署）
                const baseUrl = window.location.origin;
                const currentPath = window.location.pathname;
                
                // 確保路徑正確（Netlify 部署時，html 資料夾的檔案在根目錄）
                // 由於 netlify.toml 設定 publish = "html"，所以檔案會直接在根目錄
                let resetPasswordPath = '/reset-password.html';
                
                // 如果是本地開發且路徑包含 /html/，則使用 /html/ 前綴
                if (currentPath.includes('/html/') && baseUrl.includes('localhost')) {
                    resetPasswordPath = '/html/reset-password.html';
                } else if (currentPath.endsWith('forgot-password.html')) {
                    resetPasswordPath = currentPath.replace('forgot-password.html', 'reset-password.html');
                }
                
                const redirectUrl = baseUrl + resetPasswordPath;
                
                console.log('發送重置郵件到:', email);
                console.log('當前環境:', baseUrl);
                console.log('當前路徑:', currentPath);
                console.log('重定向 URL:', redirectUrl);
                console.log('⚠️ 請確保此 URL 已添加到 Supabase Dashboard > Authentication > URL Configuration > Redirect URLs');
                
                const { data, error } = await client.auth.resetPasswordForEmail(email, {
                    redirectTo: redirectUrl
                });
                
                if (error) {
                    console.error('發送重置郵件錯誤:', error);
                    throw error;
                }
                
                // 成功發送郵件
                statusDiv.innerHTML = '<div class="success-message">重置密碼郵件已發送到您的 Email！<br>請檢查您的收件匣（包括垃圾郵件資料夾）並點擊郵件中的連結來重置密碼。</div>';
                submitBtn.disabled = true;
                submitBtn.textContent = '郵件已發送';
                
                // 清空 email 輸入框
                document.getElementById('email').value = '';
                
            } catch (error) {
                console.error('忘記密碼錯誤:', error);
                let errorMessage = '發送重置郵件失敗，請重試';
                
                if (error.message) {
                    if (error.message.includes('not found') || error.message.includes('does not exist')) {
                        errorMessage = '此 Email 尚未註冊';
                    } else if (error.message.includes('too many requests') || error.message.includes('rate limit')) {
                        errorMessage = '請求過於頻繁，請稍後再試';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                statusDiv.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = '發送重置郵件';
            }
        }

        // 頁面載入時檢查
        window.addEventListener('DOMContentLoaded', function() {
            // 檢查是否已登入
            const client = initSupabase();
            if (client) {
                client.auth.getSession().then(({ data: { session } }) => {
                    if (session && session.user) {
                        // 已登入，跳轉到主頁
                        window.location.href = 'calendar.html';
                    }
                });
            }
        });
    </script>
</body>
</html>

