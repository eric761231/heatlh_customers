<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿˜è¨˜å¯†ç¢¼</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body class="login-page">
    <div class="login-header">
        <button class="back-btn" onclick="window.location.href='login.html'">
            <span>â†</span> è¿”å›
        </button>
        <h1 class="welcome-title">é‡è¨­å¯†ç¢¼</h1>
    </div>
    
    <div class="login-content-card">
        <h2 class="login-title">å¿˜è¨˜å¯†ç¢¼</h2>
        
        <div id="status" class="login-status"></div>
        
        <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
            <div class="form-group-modern">
                <input type="email" id="email" name="email" required placeholder="Your email" autocomplete="email" class="modern-input">
            </div>
            
            <button type="submit" class="btn-login-gradient">
                ç™¼é€é‡ç½®éƒµä»¶
            </button>
        </form>
        
        <div class="signup-link">
            <span>è¨˜èµ·å¯†ç¢¼äº†ï¼Ÿ</span>
            <a href="login.html">è¿”å›ç™»å…¥</a>
        </div>
    </div>

    <script>
        // è™•ç†å¿˜è¨˜å¯†ç¢¼è«‹æ±‚
        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const statusDiv = document.getElementById('status');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // ç²å–è¡¨å–®è³‡æ–™
            const email = document.getElementById('email').value.trim();
            
            // é©—è­‰
            if (!email) {
                statusDiv.innerHTML = '<div class="error-message">è«‹è¼¸å…¥æ‚¨çš„ Email</div>';
                return;
            }
            
            // åˆå§‹åŒ– Supabase
            const client = initSupabase();
            if (!client) {
                statusDiv.innerHTML = '<div class="error-message">ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç™¼é€ä¸­...';
            statusDiv.innerHTML = '<div style="color: #6B7280; padding: 12px; text-align: center;">æ­£åœ¨ç™¼é€é‡ç½®éƒµä»¶ï¼Œè«‹ç¨å€™...</div>';
            
            try {
                // ç™¼é€å¯†ç¢¼é‡ç½®éƒµä»¶
                // æ§‹å»ºé‡ç½®å¯†ç¢¼é é¢çš„å®Œæ•´ URL
                // ä½¿ç”¨ window.location.origin æœƒè‡ªå‹•é©æ‡‰ç’°å¢ƒï¼ˆæœ¬åœ°é–‹ç™¼æˆ– Netlify éƒ¨ç½²ï¼‰
                const baseUrl = window.location.origin;
                const currentPath = window.location.pathname;
                
                // ç¢ºä¿è·¯å¾‘æ­£ç¢ºï¼ˆNetlify éƒ¨ç½²æ™‚ï¼Œhtml è³‡æ–™å¤¾çš„æª”æ¡ˆåœ¨æ ¹ç›®éŒ„ï¼‰
                // ç”±æ–¼ netlify.toml è¨­å®š publish = "html"ï¼Œæ‰€ä»¥æª”æ¡ˆæœƒç›´æ¥åœ¨æ ¹ç›®éŒ„
                let resetPasswordPath = '/reset-password.html';
                
                // å¦‚æœæ˜¯æœ¬åœ°é–‹ç™¼ä¸”è·¯å¾‘åŒ…å« /html/ï¼Œå‰‡ä½¿ç”¨ /html/ å‰ç¶´
                if (currentPath.includes('/html/') && baseUrl.includes('localhost')) {
                    resetPasswordPath = '/html/reset-password.html';
                } else if (currentPath.endsWith('forgot-password.html')) {
                    resetPasswordPath = currentPath.replace('forgot-password.html', 'reset-password.html');
                }
                
                const redirectUrl = baseUrl + resetPasswordPath;
                
                console.log('ç™¼é€é‡ç½®éƒµä»¶åˆ°:', email);
                console.log('ç•¶å‰ç’°å¢ƒ:', baseUrl);
                console.log('ç•¶å‰è·¯å¾‘:', currentPath);
                console.log('é‡å®šå‘ URL:', redirectUrl);
                console.log('âš ï¸ è«‹ç¢ºä¿æ­¤ URL å·²æ·»åŠ åˆ° Supabase Dashboard > Authentication > URL Configuration > Redirect URLs');
                
                const { data, error } = await client.auth.resetPasswordForEmail(email, {
                    redirectTo: redirectUrl
                });
                
                if (error) {
                    console.error('ç™¼é€é‡ç½®éƒµä»¶éŒ¯èª¤:', error);
                    throw error;
                }
                
                // æˆåŠŸç™¼é€éƒµä»¶
                statusDiv.innerHTML = `
                    <div class="success-message">
                        <strong>âœ… é‡ç½®å¯†ç¢¼éƒµä»¶å·²ç™¼é€ï¼</strong><br><br>
                        ğŸ“§ è«‹æª¢æŸ¥æ‚¨çš„ Email æ”¶ä»¶åŒ£ï¼ˆåŒ…æ‹¬åƒåœ¾éƒµä»¶è³‡æ–™å¤¾ï¼‰<br><br>
                        â° <strong>æ³¨æ„ï¼š</strong> å¦‚æœä½¿ç”¨ Supabase å…è²»è¨ˆåŠƒï¼Œéƒµä»¶å¯èƒ½éœ€è¦ 1-5 åˆ†é˜æ‰æœƒé€é”<br><br>
                        
                        <details style="margin-top: 15px; text-align: left;">
                            <summary style="cursor: pointer; color: #4F46E5; font-weight: bold;">ğŸ’¡ å¦‚æœç­‰å¾ˆä¹…é‚„æ²’æ”¶åˆ°éƒµä»¶ï¼Œå¯ä»¥ï¼š</summary>
                            <ol style="margin: 10px 0; padding-left: 20px; text-align: left;">
                                <li>ç­‰å¾… 5-10 åˆ†é˜ï¼ˆå…è²»è¨ˆåŠƒéƒµä»¶è¼ƒæ…¢ï¼‰</li>
                                <li>æª¢æŸ¥åƒåœ¾éƒµä»¶è³‡æ–™å¤¾</li>
                                <li>åœ¨ <a href="https://app.supabase.com/" target="_blank" style="color: #4F46E5;">Supabase Dashboard</a> ä¸­æ‰‹å‹•ç¢ºèª Emailï¼š
                                    <ul style="margin-top: 5px; padding-left: 20px;">
                                        <li>å‰å¾€ <strong>Authentication</strong> > <strong>Users</strong></li>
                                        <li>æ‰¾åˆ° Email: <code>${email}</code></li>
                                        <li>é»æ“Šç”¨æˆ¶ï¼Œåœ¨è©³æƒ…é é¢æ‰‹å‹•ç¢ºèª Email</li>
                                    </ul>
                                </li>
                                <li>æˆ–æš«æ™‚é—œé–‰ Email é©—è­‰ä»¥å¿«é€Ÿç™»å…¥</li>
                            </ol>
                        </details>
                    </div>
                `;
                submitBtn.disabled = true;
                submitBtn.textContent = 'éƒµä»¶å·²ç™¼é€';
                
                // æ¸…ç©º email è¼¸å…¥æ¡†
                document.getElementById('email').value = '';
                
            } catch (error) {
                console.error('å¿˜è¨˜å¯†ç¢¼éŒ¯èª¤:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    status: error.status,
                    code: error.code,
                    error: error
                });
                
                let errorMessage = 'ç™¼é€é‡ç½®éƒµä»¶å¤±æ•—ï¼Œè«‹é‡è©¦';
                let debugInfo = '';
                
                if (error.message) {
                    const errMsg = error.message.toLowerCase();
                    
                    if (errMsg.includes('email logins are disabled') || 
                        errMsg.includes('email provider is disabled')) {
                        errorMessage = 'Email ç™»å…¥åŠŸèƒ½å·²è¢«é—œé–‰';
                        debugInfo = `
                            <br><br><strong>âŒ å•é¡Œï¼š</strong> Supabase çš„ Email Provider å·²è¢«é—œé–‰<br><br>
                            <strong>ğŸ”§ è§£æ±ºæ­¥é©Ÿï¼š</strong><br>
                            <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                                <li>å‰å¾€ <a href="https://app.supabase.com/" target="_blank" style="color: #4F46E5;">Supabase Dashboard</a></li>
                                <li>é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ</li>
                                <li>å‰å¾€ <strong>Authentication</strong> > <strong>Providers</strong> > <strong>Email</strong></li>
                                <li>é–‹å•Ÿ <strong>Enable email provider</strong> é¸é …</li>
                                <li>ä¿å­˜è¨­å®š</li>
                                <li>é‡æ–°å˜—è©¦é‡ç½®å¯†ç¢¼</li>
                            </ol>
                            <br><strong>ğŸ’¡ æ³¨æ„ï¼š</strong> é€™ä¹Ÿæœƒå½±éŸ¿ç™»å…¥åŠŸèƒ½ï¼Œéœ€è¦å•Ÿç”¨ Email Provider æ‰èƒ½ä½¿ç”¨ Email ç™»å…¥ã€‚
                        `;
                    } else if (errMsg.includes('not found') || errMsg.includes('does not exist')) {
                        errorMessage = 'æ­¤ Email å°šæœªè¨»å†Š';
                        debugInfo = `<br><br><a href="register.html" style="color: #4F46E5;">â†’ å‰å¾€è¨»å†Šé é¢</a>`;
                    } else if (errMsg.includes('too many requests') || errMsg.includes('rate limit')) {
                        errorMessage = 'è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                statusDiv.innerHTML = `<div class="error-message">${errorMessage}${debugInfo}</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = 'ç™¼é€é‡ç½®éƒµä»¶';
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥
        window.addEventListener('DOMContentLoaded', function() {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            const client = initSupabase();
            if (client) {
                client.auth.getSession().then(({ data: { session } }) => {
                    if (session && session.user) {
                        // å·²ç™»å…¥ï¼Œè·³è½‰åˆ°ä¸»é 
                        window.location.href = 'calendar.html';
                    }
                });
            }
        });
    </script>
</body>
</html>

