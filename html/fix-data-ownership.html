<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®æ­£è³‡æ–™æ‰€æœ‰æ¬Š</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .btn-primary {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
    </style>
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <h1>ä¿®æ­£è³‡æ–™æ‰€æœ‰æ¬Š</h1>
            <p class="login-subtitle">æ­¤å·¥å…·æœƒå°‡æ‰€æœ‰æ²’æœ‰ <code>created_by</code> çš„è³‡æ–™è¨­å®šç‚ºç•¶å‰ç™»å…¥çš„ä½¿ç”¨è€…</p>
            
            <div id="status" class="login-status"></div>
            
            <div style="margin-top: 24px;">
                <button class="btn btn-primary" onclick="fixDataOwnership()" style="width: 100%; padding: 14px 24px; font-size: 1rem; font-weight: 600;">
                    ğŸ”§ é–‹å§‹ä¿®æ­£è³‡æ–™
                </button>
            </div>
            
            <div style="margin-top: 16px;">
                <a href="calendar.html" class="btn btn-secondary" style="width: 100%; text-align: center; display: block; padding: 12px 24px;">
                    â† è¿”å›ä¸»é 
                </a>
            </div>
            
            <div style="margin-top: 12px;">
                <a href="login.html" class="btn btn-secondary" style="width: 100%; text-align: center; display: block; padding: 12px 24px; background: rgba(255, 255, 255, 0.05);">
                    ç™»å‡ºä¸¦è¿”å›ç™»å…¥é é¢
                </a>
            </div>
        </div>
    </div>

    <script>
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkAuth() {
            const loginInfo = localStorage.getItem('googleLogin');
            console.log('localStorage ä¸­çš„ç™»å…¥è³‡è¨Š:', loginInfo ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            
            if (!loginInfo) {
                console.log('æ²’æœ‰ç™»å…¥è³‡è¨Š');
                return null;
            }
            
            try {
                const userInfo = JSON.parse(loginInfo);
                console.log('è§£æå¾Œçš„ç”¨æˆ¶è³‡è¨Š:', userInfo);
                
                if (userInfo.email) {
                    // æª¢æŸ¥æ˜¯å¦éæœŸï¼ˆå¦‚æœæœ‰ exp æ¬„ä½ï¼‰
                    if (userInfo.exp) {
                        const now = Date.now();
                        if (now >= userInfo.exp) {
                            console.log('ç™»å…¥å·²éæœŸ');
                            return null;
                        }
                    }
                    console.log('ç™»å…¥é©—è­‰æˆåŠŸï¼Œç”¨æˆ¶:', userInfo.email);
                    return userInfo;
                } else {
                    console.log('ç”¨æˆ¶è³‡è¨Šä¸­æ²’æœ‰ email');
                    return null;
                }
            } catch (e) {
                console.error('è§£æç™»å…¥è³‡è¨Šå¤±æ•—:', e);
                return null;
            }
        }

        // ä¿®æ­£è³‡æ–™æ‰€æœ‰æ¬Š
        async function fixDataOwnership() {
            const user = checkAuth();
            if (!user) {
                return;
            }

            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div style="color: rgba(255,255,255,0.8);">æ­£åœ¨ä¿®æ­£è³‡æ–™ï¼Œè«‹ç¨å€™...</div>';

            try {
                // æª¢æŸ¥ Supabase æ˜¯å¦å·²è¼‰å…¥
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase JS åº«æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
                
                // æª¢æŸ¥é…ç½®
                if (typeof SUPABASE_URL === 'undefined' || typeof SUPABASE_ANON_KEY === 'undefined') {
                    throw new Error('Supabase é…ç½®æœªè¨­å®šï¼Œè«‹æª¢æŸ¥ config.js');
                }
                
                // åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
                const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                if (!client) {
                    throw new Error('ç„¡æ³•å»ºç«‹ Supabase å®¢æˆ¶ç«¯');
                }

                const userEmail = user.email;
                let updatedCount = {
                    customers: 0,
                    schedules: 0,
                    orders: 0
                };

                // æ›´æ–°å®¢æˆ¶è³‡æ–™ï¼ˆåŒ…å«ç©ºå­—ä¸²ï¼‰
                const { data: customers, error: customersError } = await client
                    .from('customers')
                    .update({ created_by: userEmail })
                    .or('created_by.is.null,created_by.eq.')
                    .select();
                
                if (customersError) {
                    console.error('æ›´æ–°å®¢æˆ¶è³‡æ–™éŒ¯èª¤:', customersError);
                    statusDiv.innerHTML += '<div class="error-message" style="margin-top: 8px;">å®¢æˆ¶è³‡æ–™æ›´æ–°éŒ¯èª¤ï¼š' + customersError.message + '</div>';
                } else {
                    updatedCount.customers = customers ? customers.length : 0;
                }

                // æ›´æ–°è¡Œç¨‹è³‡æ–™ï¼ˆåŒ…å«ç©ºå­—ä¸²ï¼‰
                const { data: schedules, error: schedulesError } = await client
                    .from('schedules')
                    .update({ created_by: userEmail })
                    .or('created_by.is.null,created_by.eq.')
                    .select();
                
                if (schedulesError) {
                    console.error('æ›´æ–°è¡Œç¨‹è³‡æ–™éŒ¯èª¤:', schedulesError);
                    statusDiv.innerHTML += '<div class="error-message" style="margin-top: 8px;">è¡Œç¨‹è³‡æ–™æ›´æ–°éŒ¯èª¤ï¼š' + schedulesError.message + '</div>';
                } else {
                    updatedCount.schedules = schedules ? schedules.length : 0;
                }

                // æ›´æ–°è¨‚å–®è³‡æ–™ï¼ˆåŒ…å«ç©ºå­—ä¸²ï¼‰
                const { data: orders, error: ordersError } = await client
                    .from('orders')
                    .update({ created_by: userEmail })
                    .or('created_by.is.null,created_by.eq.')
                    .select();
                
                if (ordersError) {
                    console.error('æ›´æ–°è¨‚å–®è³‡æ–™éŒ¯èª¤:', ordersError);
                    statusDiv.innerHTML += '<div class="error-message" style="margin-top: 8px;">è¨‚å–®è³‡æ–™æ›´æ–°éŒ¯èª¤ï¼š' + ordersError.message + '</div>';
                } else {
                    updatedCount.orders = orders ? orders.length : 0;
                }

                // é¡¯ç¤ºçµæœ
                statusDiv.innerHTML = `
                    <div class="success-message">
                        <h3 style="margin-bottom: 12px;">ä¿®æ­£å®Œæˆï¼</h3>
                        <p>å·²æ›´æ–° ${updatedCount.customers} ç­†å®¢æˆ¶è³‡æ–™</p>
                        <p>å·²æ›´æ–° ${updatedCount.schedules} ç­†è¡Œç¨‹è³‡æ–™</p>
                        <p>å·²æ›´æ–° ${updatedCount.orders} ç­†è¨‚å–®è³‡æ–™</p>
                        <p style="margin-top: 16px;">ç¾åœ¨æ‚¨å¯ä»¥æ­£å¸¸æŸ¥çœ‹æ‰€æœ‰è³‡æ–™äº†ã€‚</p>
                    </div>
                `;

            } catch (error) {
                console.error('ä¿®æ­£è³‡æ–™æ‰€æœ‰æ¬ŠéŒ¯èª¤:', error);
                statusDiv.innerHTML = '<div class="error-message">ä¿®æ­£å¤±æ•—ï¼š' + error.message + '<br>è«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ä»¥ç²å–è©³ç´°éŒ¯èª¤è¨Šæ¯</div>';
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥
        window.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹æª¢æŸ¥ç™»å…¥ç‹€æ…‹...');
            const user = checkAuth();
            console.log('ç™»å…¥æª¢æŸ¥çµæœ:', user);
            
            if (!user) {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `
                    <div class="error-message" style="margin-bottom: 16px;">
                        <p>è«‹å…ˆç™»å…¥ç³»çµ±</p>
                        <p>3ç§’å¾Œå°‡è‡ªå‹•è·³è½‰åˆ°ç™»å…¥é é¢...</p>
                    </div>
                `;
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            } else {
                // é¡¯ç¤ºç•¶å‰ç”¨æˆ¶è³‡è¨Š
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `
                    <div class="success-message" style="margin-bottom: 16px;">
                        <p><strong>ç•¶å‰ç™»å…¥ç”¨æˆ¶ï¼š</strong>${user.email}</p>
                        <p style="margin-top: 8px;">æ­¤å·¥å…·æœƒå°‡æ‰€æœ‰æ²’æœ‰ <code>created_by</code> çš„è³‡æ–™è¨­å®šç‚ºæ‚¨çš„å¸³è™Ÿ</p>
                        <p style="margin-top: 8px;">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ä¿®æ­£è³‡æ–™</p>
                    </div>
                `;
                
                // ç¢ºä¿æŒ‰éˆ•å¯è¦‹
                const button = document.querySelector('.btn-primary');
                if (button) {
                    button.style.display = 'block';
                    button.style.visibility = 'visible';
                    button.style.opacity = '1';
                }
            }
        });
    </script>
</body>
</html>

