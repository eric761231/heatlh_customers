<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>註冊帳號</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body class="login-page">
    <div class="login-header">
        <button class="back-btn" onclick="window.history.back()" style="display: none;" id="backBtn">
            <span>←</span> 返回
        </button>
        <h1 class="welcome-title" id="welcomeTitle">歡迎加入</h1>
    </div>
    
    <div class="login-content-card">
        <h2 class="login-title">註冊</h2>
        
        <div id="status" class="login-status"></div>
        
        <form id="registerForm" onsubmit="handleRegister(event)">
            <div class="form-group-modern">
                <input type="text" id="name" name="name" required placeholder="Your name" autocomplete="name" class="modern-input">
            </div>
            
            <div class="form-group-modern">
                <input type="email" id="email" name="email" required placeholder="Your email" autocomplete="email" class="modern-input">
            </div>
            
            <div class="form-group-modern">
                <input type="password" id="password" name="password" required placeholder="Password (至少 6 個字元)" autocomplete="new-password" class="modern-input" minlength="6">
            </div>
            
            <div class="form-group-modern">
                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm password" autocomplete="new-password" class="modern-input" minlength="6">
            </div>
            
            <button type="submit" class="btn-login-gradient">
                註冊帳號
            </button>
        </form>
        
        <div class="signup-link">
            <span>已有帳號？</span>
            <a href="login.html">立即登入</a>
        </div>
    </div>

    <script>
        // 使用 supabase-client.js 中已提供的 initSupabase 函數
        // 不需要重新宣告 supabaseClient，因為 supabase-client.js 已經提供了

        // 處理註冊
        async function handleRegister(event) {
            event.preventDefault();
            
            const statusDiv = document.getElementById('status');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // 獲取表單資料
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // 驗證
            if (!name || !email || !password) {
                statusDiv.innerHTML = '<div class="error-message">請填寫所有欄位</div>';
                return;
            }
            
            if (password.length < 6) {
                statusDiv.innerHTML = '<div class="error-message">密碼長度至少需要 6 個字元</div>';
                return;
            }
            
            if (password !== confirmPassword) {
                statusDiv.innerHTML = '<div class="error-message">兩次輸入的密碼不一致</div>';
                return;
            }
            
            // 初始化 Supabase
            const client = initSupabase();
            if (!client) {
                statusDiv.innerHTML = '<div class="error-message">系統初始化失敗，請重新整理頁面</div>';
                return;
            }
            
            // 顯示載入狀態
            submitBtn.disabled = true;
            submitBtn.textContent = '註冊中...';
            statusDiv.innerHTML = '<div style="color: #6B7280; padding: 12px; text-align: center;">正在註冊，請稍候...</div>';
            
            try {
                // 註冊新用戶
                const { data, error } = await client.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name
                        },
                        emailRedirectTo: window.location.origin + '/login.html'
                    }
                });
                
                if (error) {
                    throw error;
                }
                
                // 檢查註冊結果
                if (!data.user) {
                    throw new Error('註冊失敗，未收到用戶資料');
                }
                
                // 嘗試建立 users 表記錄
                let dbSuccess = false;
                let dbErrorMsg = '';
                
                try {
                    const { data: userData, error: dbError } = await client
                        .from('users')
                        .upsert({
                            id: data.user.id,
                            user_login: email, // 使用 email 作為 user_login
                            name: name,
                            last_login: new Date().toISOString()
                        }, { onConflict: 'id' })
                        .select()
                        .single();
                    
                    if (dbError) {
                        console.error('建立用戶資料記錄失敗:', dbError);
                        dbErrorMsg = dbError.message || '資料庫寫入失敗';
                        
                        // 如果是 RLS 政策問題，提示用戶
                        if (dbError.message && (dbError.message.includes('permission') || dbError.message.includes('policy') || dbError.message.includes('RLS'))) {
                            dbErrorMsg = '資料庫權限問題，請聯繫管理員檢查 RLS 政策';
                        }
                    } else {
                        dbSuccess = true;
                        console.log('用戶資料已成功建立:', userData);
                    }
                } catch (e) {
                    console.error('建立用戶資料記錄時發生錯誤:', e);
                    dbErrorMsg = e.message || '未知錯誤';
                }
                
                // 檢查是否需要 Email 確認
                if (data.user && !data.session) {
                    // 需要 Email 確認的情況
                    if (dbSuccess) {
                        statusDiv.innerHTML = '<div class="success-message">註冊成功！用戶資料已建立。請檢查您的 Email 並點擊確認連結後再登入</div>';
                    } else {
                        statusDiv.innerHTML = `<div class="success-message">註冊成功！但用戶資料建立失敗：${dbErrorMsg}。請先確認 Email，登入時會自動建立用戶資料。</div>`;
                    }
                    
                    // 3秒後跳轉到登入頁面
                    setTimeout(() => {
                        window.location.href = 'login.html?registered=true';
                    }, 3000);
                    return;
                }
                
                // 註冊成功且已自動登入（不需要 Email 確認的情況）
                if (data.user && data.session) {
                    if (dbSuccess) {
                        statusDiv.innerHTML = '<div class="success-message">註冊成功！用戶資料已建立。正在跳轉...</div>';
                    } else {
                        statusDiv.innerHTML = `<div class="error-message">註冊成功但用戶資料建立失敗：${dbErrorMsg}。請聯繫管理員或稍後再試。</div>`;
                        submitBtn.disabled = false;
                        submitBtn.textContent = '註冊帳號';
                        return;
                    }
                    
                    // 註冊成功，直接跳轉到主頁面
                    setTimeout(() => {
                        window.location.href = 'calendar.html';
                    }, 1000);
                    return;
                }
                
                // 其他情況：註冊成功但狀態不明確
                if (dbSuccess) {
                    statusDiv.innerHTML = '<div class="success-message">註冊成功！正在跳轉到登入頁面...</div>';
                } else {
                    statusDiv.innerHTML = `<div class="success-message">註冊成功！但用戶資料建立失敗：${dbErrorMsg}。登入時會自動建立用戶資料。</div>`;
                }
                
                setTimeout(() => {
                    window.location.href = 'login.html?registered=true';
                }, 2000);
                
            } catch (error) {
                console.error('註冊錯誤:', error);
                let errorMessage = '註冊失敗，請重試';
                
                if (error.message) {
                    if (error.message.includes('already registered') || error.message.includes('already exists') || error.message.includes('User already registered')) {
                        errorMessage = '此 Email 已被註冊，請使用其他 Email 或直接登入';
                    } else if (error.message.includes('invalid') || error.message.includes('Invalid')) {
                        errorMessage = 'Email 格式不正確';
                    } else if (error.message.includes('Password')) {
                        errorMessage = '密碼不符合要求';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                statusDiv.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = '註冊帳號';
            }
        }

        // 頁面載入時初始化
        window.addEventListener('DOMContentLoaded', function() {
            initSupabase();
        });
    </script>
</body>
</html>




