<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨»å†Šå¸³è™Ÿ</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body class="login-page">
    <div class="login-header">
        <button class="back-btn" onclick="window.history.back()" style="display: none;" id="backBtn">
            <span>â†</span> è¿”å›
        </button>
        <h1 class="welcome-title" id="welcomeTitle">æ­¡è¿åŠ å…¥</h1>
    </div>
    
    <div class="login-content-card">
        <h2 class="login-title">è¨»å†Š</h2>
        
        <div id="status" class="login-status"></div>
        
        <form id="registerForm" onsubmit="handleRegister(event)">
            <div class="form-group-modern">
                <input type="text" id="name" name="name" required placeholder="Your name" autocomplete="name" class="modern-input">
            </div>
            
            <div class="form-group-modern">
                <input type="email" id="email" name="email" required placeholder="Your email" autocomplete="email" class="modern-input">
            </div>
            
            <div class="form-group-modern">
                <input type="password" id="password" name="password" required placeholder="Password (è‡³å°‘ 6 å€‹å­—å…ƒ)" autocomplete="new-password" class="modern-input" minlength="6">
            </div>
            
            <div class="form-group-modern">
                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm password" autocomplete="new-password" class="modern-input" minlength="6">
            </div>
            
            <button type="submit" class="btn-login-gradient">
                è¨»å†Šå¸³è™Ÿ
            </button>
        </form>
        
        <div class="signup-link">
            <span>å·²æœ‰å¸³è™Ÿï¼Ÿ</span>
            <a href="login.html">ç«‹å³ç™»å…¥</a>
        </div>
    </div>

    <script>
        // ä½¿ç”¨ supabase-client.js ä¸­å·²æä¾›çš„ initSupabase å‡½æ•¸
        // ä¸éœ€è¦é‡æ–°å®£å‘Š supabaseClientï¼Œå› ç‚º supabase-client.js å·²ç¶“æä¾›äº†

        // è™•ç†è¨»å†Š
        async function handleRegister(event) {
            event.preventDefault();
            
            const statusDiv = document.getElementById('status');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // ç²å–è¡¨å–®è³‡æ–™
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // é©—è­‰
            if (!name || !email || !password) {
                statusDiv.innerHTML = '<div class="error-message">è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½</div>';
                return;
            }
            
            if (password.length < 6) {
                statusDiv.innerHTML = '<div class="error-message">å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ</div>';
                return;
            }
            
            if (password !== confirmPassword) {
                statusDiv.innerHTML = '<div class="error-message">å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´</div>';
                return;
            }
            
            // åˆå§‹åŒ– Supabase
            const client = initSupabase();
            if (!client) {
                statusDiv.innerHTML = '<div class="error-message">ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            submitBtn.disabled = true;
            submitBtn.textContent = 'è¨»å†Šä¸­...';
            statusDiv.innerHTML = '<div style="color: #6B7280; padding: 12px; text-align: center;">æ­£åœ¨è¨»å†Šï¼Œè«‹ç¨å€™...</div>';
            
            try {
                // è¨»å†Šæ–°ç”¨æˆ¶
                const { data, error } = await client.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name
                        },
                        emailRedirectTo: window.location.origin + '/login.html'
                    }
                });
                
                if (error) {
                    throw error;
                }
                
                // æª¢æŸ¥è¨»å†Šçµæœ
                if (!data.user) {
                    throw new Error('è¨»å†Šå¤±æ•—ï¼Œæœªæ”¶åˆ°ç”¨æˆ¶è³‡æ–™');
                }
                
                // å˜—è©¦å»ºç«‹ users è¡¨è¨˜éŒ„
                let dbSuccess = false;
                let dbErrorMsg = '';
                
                try {
                    const { data: userData, error: dbError } = await client
                        .from('users')
                        .upsert({
                            id: data.user.id,
                            user_login: email, // ä½¿ç”¨ email ä½œç‚º user_login
                            name: name,
                            last_login: new Date().toISOString()
                        }, { onConflict: 'id' })
                        .select()
                        .single();
                    
                    if (dbError) {
                        console.error('å»ºç«‹ç”¨æˆ¶è³‡æ–™è¨˜éŒ„å¤±æ•—:', dbError);
                        dbErrorMsg = dbError.message || 'è³‡æ–™åº«å¯«å…¥å¤±æ•—';
                        
                        // å¦‚æœæ˜¯ RLS æ”¿ç­–å•é¡Œï¼Œæç¤ºç”¨æˆ¶
                        if (dbError.message && (dbError.message.includes('permission') || dbError.message.includes('policy') || dbError.message.includes('RLS'))) {
                            dbErrorMsg = 'è³‡æ–™åº«æ¬Šé™å•é¡Œï¼Œè«‹è¯ç¹«ç®¡ç†å“¡æª¢æŸ¥ RLS æ”¿ç­–';
                        }
                    } else {
                        dbSuccess = true;
                        console.log('ç”¨æˆ¶è³‡æ–™å·²æˆåŠŸå»ºç«‹:', userData);
                    }
                } catch (e) {
                    console.error('å»ºç«‹ç”¨æˆ¶è³‡æ–™è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                    dbErrorMsg = e.message || 'æœªçŸ¥éŒ¯èª¤';
                }
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦ Email ç¢ºèª
                console.log('è¨»å†Šçµæœæª¢æŸ¥:', {
                    hasUser: !!data.user,
                    hasSession: !!data.session,
                    emailConfirmed: data.user?.email_confirmed_at,
                    userId: data.user?.id,
                    userEmail: data.user?.email
                });
                
                if (data.user && !data.session) {
                    // éœ€è¦ Email ç¢ºèªçš„æƒ…æ³
                    console.log('éœ€è¦ Email ç¢ºèª - å°‡è·³è½‰åˆ°ç™»å…¥é é¢');
                    if (dbSuccess) {
                        statusDiv.innerHTML = '<div class="success-message">è¨»å†ŠæˆåŠŸï¼ç”¨æˆ¶è³‡æ–™å·²å»ºç«‹ã€‚<br><br>ğŸ“§ é©—è­‰éƒµä»¶å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ Email æ”¶ä»¶åŒ£ï¼ˆåŒ…æ‹¬åƒåœ¾éƒµä»¶è³‡æ–™å¤¾ï¼‰ã€‚<br><br>ğŸ’¡ æç¤ºï¼šéƒµä»¶å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ‰èƒ½é€é”ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚<br><br>é»æ“Šéƒµä»¶ä¸­çš„ç¢ºèªé€£çµå¾Œå³å¯ç™»å…¥ã€‚</div>';
                    } else {
                        statusDiv.innerHTML = `<div class="success-message">è¨»å†ŠæˆåŠŸï¼ä½†ç”¨æˆ¶è³‡æ–™å»ºç«‹å¤±æ•—ï¼š${dbErrorMsg}ã€‚<br><br>ğŸ“§ é©—è­‰éƒµä»¶å·²ç™¼é€ï¼Œè«‹å…ˆç¢ºèª Emailï¼Œç™»å…¥æ™‚æœƒè‡ªå‹•å»ºç«‹ç”¨æˆ¶è³‡æ–™ã€‚</div>`;
                    }
                    
                    // 5ç§’å¾Œè·³è½‰åˆ°ç™»å…¥é é¢ï¼ˆçµ¦ç”¨æˆ¶æ›´å¤šæ™‚é–“é–±è®€è¨Šæ¯ï¼‰
                    setTimeout(() => {
                        window.location.href = 'login.html?registered=true';
                    }, 5000);
                    return;
                }
                
                // è¨»å†ŠæˆåŠŸä¸”å·²è‡ªå‹•ç™»å…¥ï¼ˆä¸éœ€è¦ Email ç¢ºèªçš„æƒ…æ³ï¼‰
                if (data.user && data.session) {
                    console.log('è¨»å†ŠæˆåŠŸä¸”å·²è‡ªå‹•ç™»å…¥ï¼ˆä¸éœ€è¦ Email ç¢ºèªï¼‰- å°‡ç›´æ¥è·³è½‰åˆ°ä¸»é ');
                    if (dbSuccess) {
                        statusDiv.innerHTML = '<div class="success-message">è¨»å†ŠæˆåŠŸï¼ç”¨æˆ¶è³‡æ–™å·²å»ºç«‹ã€‚æ­£åœ¨è·³è½‰...</div>';
                    } else {
                        // å³ä½¿ users è¡¨å»ºç«‹å¤±æ•—ï¼Œä¹Ÿå…è¨±ç™»å…¥ï¼ˆç™»å…¥æ™‚æœƒè‡ªå‹•å»ºç«‹ï¼‰
                        console.warn('users è¡¨å»ºç«‹å¤±æ•—ï¼Œä½†å…è¨±ç™»å…¥ï¼ˆç™»å…¥æ™‚æœƒè‡ªå‹•å»ºç«‹ï¼‰');
                        statusDiv.innerHTML = `<div class="success-message">è¨»å†ŠæˆåŠŸï¼ç”¨æˆ¶è³‡æ–™å»ºç«‹å¤±æ•—ï¼š${dbErrorMsg}ï¼Œä½†å¯ä»¥ç™»å…¥ï¼ˆç™»å…¥æ™‚æœƒè‡ªå‹•å»ºç«‹ç”¨æˆ¶è³‡æ–™ï¼‰ã€‚æ­£åœ¨è·³è½‰...</div>`;
                    }
                    
                    // è¨»å†ŠæˆåŠŸï¼Œç›´æ¥è·³è½‰åˆ°ä¸»é é¢
                    setTimeout(() => {
                        window.location.href = 'calendar.html';
                    }, 1000);
                    return;
                }
                
                // å…¶ä»–æƒ…æ³ï¼šè¨»å†ŠæˆåŠŸä½†ç‹€æ…‹ä¸æ˜ç¢º
                if (dbSuccess) {
                    statusDiv.innerHTML = '<div class="success-message">è¨»å†ŠæˆåŠŸï¼æ­£åœ¨è·³è½‰åˆ°ç™»å…¥é é¢...</div>';
                } else {
                    statusDiv.innerHTML = `<div class="success-message">è¨»å†ŠæˆåŠŸï¼ä½†ç”¨æˆ¶è³‡æ–™å»ºç«‹å¤±æ•—ï¼š${dbErrorMsg}ã€‚ç™»å…¥æ™‚æœƒè‡ªå‹•å»ºç«‹ç”¨æˆ¶è³‡æ–™ã€‚</div>`;
                }
                
                setTimeout(() => {
                    window.location.href = 'login.html?registered=true';
                }, 2000);
                
            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                let errorMessage = 'è¨»å†Šå¤±æ•—ï¼Œè«‹é‡è©¦';
                
                if (error.message) {
                    if (error.message.includes('already registered') || error.message.includes('already exists') || error.message.includes('User already registered')) {
                        errorMessage = 'æ­¤ Email å·²è¢«è¨»å†Šï¼Œè«‹ä½¿ç”¨å…¶ä»– Email æˆ–ç›´æ¥ç™»å…¥';
                    } else if (error.message.includes('invalid') || error.message.includes('Invalid')) {
                        errorMessage = 'Email æ ¼å¼ä¸æ­£ç¢º';
                    } else if (error.message.includes('Password')) {
                        errorMessage = 'å¯†ç¢¼ä¸ç¬¦åˆè¦æ±‚';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                statusDiv.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = 'è¨»å†Šå¸³è™Ÿ';
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            initSupabase();
        });
    </script>
</body>
</html>




