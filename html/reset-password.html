<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重置密碼</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body class="login-page">
    <div class="login-header">
        <button class="back-btn" onclick="window.location.href='login.html'">
            <span>←</span> 返回
        </button>
        <h1 class="welcome-title">重置密碼</h1>
    </div>
    
    <div class="login-content-card">
        <h2 class="login-title">設定新密碼</h2>
        
        <div id="status" class="login-status"></div>
        
        <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
            <div class="form-group-modern">
                <input type="password" id="newPassword" name="newPassword" required placeholder="新密碼 (至少 6 個字元)" autocomplete="new-password" class="modern-input" minlength="6">
            </div>
            
            <div class="form-group-modern">
                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="確認新密碼" autocomplete="new-password" class="modern-input" minlength="6">
            </div>
            
            <button type="submit" class="btn-login-gradient">
                重置密碼
            </button>
        </form>
        
        <div class="signup-link">
            <span>記起密碼了？</span>
            <a href="login.html">返回登入</a>
        </div>
    </div>

    <script>
        let isTokenValid = false;

        // 檢查重置 token
        async function checkResetToken() {
            const statusDiv = document.getElementById('status');
            const client = initSupabase();
            
            if (!client) {
                statusDiv.innerHTML = '<div class="error-message">系統初始化失敗，請重新整理頁面</div>';
                return false;
            }
            
            try {
                // 先檢查 URL 中是否有錯誤參數（從 query string 或 hash）
                const urlParams = new URLSearchParams(window.location.search);
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                
                // 檢查錯誤參數
                const urlError = urlParams.get('error') || hashParams.get('error');
                const errorCode = urlParams.get('error_code') || hashParams.get('error_code');
                const errorDescription = urlParams.get('error_description') || hashParams.get('error_description');
                
                if (urlError) {
                    console.error('重置連結錯誤:', { error: urlError, errorCode, errorDescription });
                    
                    let errorMessage = '重置連結無法使用';
                    if (errorCode === 'otp_expired') {
                        errorMessage = '重置連結已過期（連結通常在 24 小時內有效）';
                    } else if (errorCode === 'access_denied') {
                        errorMessage = '無法存取重置連結';
                    }
                    
                    if (errorDescription) {
                        const decodedDescription = decodeURIComponent(errorDescription.replace(/\+/g, ' '));
                        errorMessage += '<br><br>詳細說明：' + decodedDescription;
                    }
                    
                    errorMessage += '<br><br>請返回登入頁面重新申請重置密碼。';
                    statusDiv.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                    return false;
                }
                
                // 從 URL hash 中獲取 token（Supabase 會將 token 放在 hash 中）
                const accessToken = hashParams.get('access_token');
                const type = hashParams.get('type');
                const refreshToken = hashParams.get('refresh_token');
                
                console.log('檢查 token:', { hasAccessToken: !!accessToken, type, hasRefreshToken: !!refreshToken });
                
                // 如果 URL hash 中有 access_token 和 type=recovery，說明是從重置郵件來的
                if (accessToken && type === 'recovery' && refreshToken) {
                    try {
                        // 設置 session（Supabase 會自動處理）
                        const { data: sessionData, error: sessionError } = await client.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        });
                        
                        if (sessionError) {
                            console.error('設置 session 錯誤:', sessionError);
                            statusDiv.innerHTML = '<div class="error-message">重置連結已過期或無效<br>請返回登入頁面重新申請重置密碼</div>';
                            return false;
                        }
                        
                        if (sessionData.session && sessionData.user) {
                            isTokenValid = true;
                            // 清除 URL hash，避免洩露 token
                            window.history.replaceState(null, '', window.location.pathname);
                            return true;
                        }
                    } catch (e) {
                        console.error('設置 session 錯誤:', e);
                        statusDiv.innerHTML = '<div class="error-message">處理重置連結時發生錯誤<br>請返回登入頁面重新申請重置密碼</div>';
                        return false;
                    }
                }
                
                // 檢查是否已有有效的 session（可能是從重置郵件連結來的，已經設置了 session）
                const { data: { session }, error: sessionError } = await client.auth.getSession();
                
                if (sessionError) {
                    console.error('檢查 session 錯誤:', sessionError);
                }
                
                if (session && session.user) {
                    // 有有效的 session，可能是從重置郵件來的
                    isTokenValid = true;
                    return true;
                }
                
                // 沒有有效的重置 token
                statusDiv.innerHTML = '<div class="error-message">無效的重置連結或連結已過期<br>請返回登入頁面重新申請重置密碼</div>';
                return false;
                
            } catch (error) {
                console.error('檢查重置 token 錯誤:', error);
                statusDiv.innerHTML = '<div class="error-message">驗證重置連結時發生錯誤，請重新申請</div>';
                return false;
            }
        }

        // 處理重置密碼
        async function handleResetPassword(event) {
            event.preventDefault();
            
            if (!isTokenValid) {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = '<div class="error-message">無效的重置連結，請重新申請重置密碼</div>';
                return;
            }
            
            const statusDiv = document.getElementById('status');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // 獲取表單資料
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // 驗證
            if (!newPassword || !confirmPassword) {
                statusDiv.innerHTML = '<div class="error-message">請填寫所有欄位</div>';
                return;
            }
            
            if (newPassword.length < 6) {
                statusDiv.innerHTML = '<div class="error-message">密碼長度至少需要 6 個字元</div>';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                statusDiv.innerHTML = '<div class="error-message">兩次輸入的密碼不一致</div>';
                return;
            }
            
            // 初始化 Supabase
            const client = initSupabase();
            if (!client) {
                statusDiv.innerHTML = '<div class="error-message">系統初始化失敗，請重新整理頁面</div>';
                return;
            }
            
            // 顯示載入狀態
            submitBtn.disabled = true;
            submitBtn.textContent = '重置中...';
            statusDiv.innerHTML = '<div style="color: #6B7280; padding: 12px; text-align: center;">正在重置密碼，請稍候...</div>';
            
            try {
                // 更新密碼
                const { data, error } = await client.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    console.error('重置密碼錯誤:', error);
                    throw error;
                }
                
                // 重置成功
                statusDiv.innerHTML = '<div class="success-message">密碼重置成功！正在跳轉到登入頁面...</div>';
                
                // 3秒後跳轉到登入頁面
                setTimeout(() => {
                    window.location.href = 'login.html?passwordReset=true';
                }, 2000);
                
            } catch (error) {
                console.error('重置密碼錯誤:', error);
                let errorMessage = '重置密碼失敗，請重試';
                
                if (error.message) {
                    if (error.message.includes('same password') || error.message.includes('identical')) {
                        errorMessage = '新密碼不能與舊密碼相同';
                    } else if (error.message.includes('weak password') || error.message.includes('too weak')) {
                        errorMessage = '密碼強度不足，請使用更複雜的密碼';
                    } else if (error.message.includes('expired') || error.message.includes('invalid')) {
                        errorMessage = '重置連結已過期，請重新申請重置密碼';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                statusDiv.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = '重置密碼';
            }
        }

        // 頁面載入時檢查重置 token
        window.addEventListener('DOMContentLoaded', async function() {
            await checkResetToken();
        });
    </script>
</body>
</html>

