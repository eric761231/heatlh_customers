<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·¨è¼¯å®¢æˆ¶</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="js/taiwan-address.js"></script>
</head>
<body>
    <!-- å´é‚Šå°èˆªæ¬„ -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>é¸å–®</h2>
            <button class="close-btn" onclick="toggleSidebar()">Ã—</button>
        </div>
        <nav class="sidebar-nav">
            <a href="add-customer.html" class="nav-item">
                <span class="nav-icon">â•</span>
                <span>æ–°å¢å®¢æˆ¶</span>
            </a>
            <a href="calendar.html" class="nav-item">
                <span class="nav-icon">ğŸ“…</span>
                <span>è¡Œç¨‹äº‹é …</span>
            </a>
            <a href="customers.html" class="nav-item active">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>å®¢æˆ¶è³‡æ–™</span>
            </a>
            <a href="orders.html" class="nav-item">
                <span class="nav-icon">ğŸ“¦</span>
                <span>è¨‚è²¨æ¸…å–®</span>
            </a>
            <div class="nav-divider"></div>
            <a href="#" class="nav-item" onclick="logout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ç™»å‡º</span>
            </a>
        </nav>
    </div>

    <!-- å´é‚Šæ¬„é®ç½© -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-content">
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="header">
            <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
            <h1>ç·¨è¼¯å®¢æˆ¶</h1>
            <a href="customers.html" class="btn btn-secondary">è¿”å›å®¢æˆ¶åˆ—è¡¨</a>
        </header>

        <!-- ç·¨è¼¯å®¢æˆ¶è¡¨å–® -->
        <div class="container">
            <div class="form-card">
                <h2>ç·¨è¼¯å®¢æˆ¶è³‡æ–™</h2>
                <form id="customerForm" onsubmit="handleSubmit(event)">
                    <input type="hidden" id="customerId" name="customerId">
                    
                    <div class="form-group">
                        <label for="name">å§“å <span class="required">*</span></label>
                        <input type="text" id="name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">é€šè¨Šé›»è©± <span class="required">*</span></label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>

                    <div class="form-group">
                        <label for="city">ç¸£å¸‚ <span class="required">*</span></label>
                        <select id="city" name="city" required onchange="updateDistricts()">
                            <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="district">é„‰é®å¸‚å€ <span class="required">*</span></label>
                        <select id="district" name="district" required>
                            <option value="">è«‹å…ˆé¸æ“‡ç¸£å¸‚</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="village">æ‘/é‡Œ</label>
                        <input type="text" id="village" name="village" placeholder="ä¾‹å¦‚ï¼šé«˜æ—æ‘ã€ä¸­æ­£é‡Œ">
                    </div>

                    <div class="form-group">
                        <label for="neighborhood">é„°</label>
                        <input type="text" id="neighborhood" name="neighborhood" placeholder="ä¾‹å¦‚ï¼š8é„°">
                    </div>

                    <div class="form-group">
                        <label for="streetType">è·¯è¡—é¡å‹</label>
                        <select id="streetType" name="streetType">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="è·¯">è·¯</option>
                            <option value="è¡—">è¡—</option>
                            <option value="å¤§é“">å¤§é“</option>
                            <option value="é“">é“</option>
                            <option value="æ®µ">æ®µ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="streetName">è·¯è¡—åç¨±</label>
                        <input type="text" id="streetName" name="streetName" placeholder="ä¾‹å¦‚ï¼šä¸­å±±è·¯ã€ä¸­æ­£è¡—">
                    </div>

                    <div class="form-row">
                        <div class="form-group form-group-half">
                            <label for="lane">å··</label>
                            <input type="text" id="lane" name="lane" placeholder="ä¾‹å¦‚ï¼š1">
                        </div>
                        <div class="form-group form-group-half">
                            <label for="alley">å¼„</label>
                            <input type="text" id="alley" name="alley" placeholder="ä¾‹å¦‚ï¼š2">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group form-group-half">
                            <label for="number">è™Ÿ</label>
                            <input type="text" id="number" name="number" placeholder="ä¾‹å¦‚ï¼š100">
                        </div>
                        <div class="form-group form-group-half">
                            <label for="floor">æ¨“</label>
                            <input type="text" id="floor" name="floor" placeholder="ä¾‹å¦‚ï¼š5æ¨“">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="addressDetail">è©³ç´°åœ°å€ï¼ˆå®Œæ•´åœ°å€ï¼‰</label>
                        <textarea id="addressDetail" name="addressDetail" rows="3" placeholder="ç³»çµ±æœƒè‡ªå‹•çµ„åˆå®Œæ•´åœ°å€ï¼Œæˆ–å¯æ‰‹å‹•è¼¸å…¥å®Œæ•´åœ°å€"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="avatar">é ­åƒ</label>
                        <div class="avatar-upload">
                            <input type="file" id="avatar" name="avatar" accept="image/*" onchange="handleAvatarUpload(event)">
                            <div class="avatar-preview" id="avatarPreview">
                                <span>é»æ“Šé¸æ“‡åœ–ç‰‡</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="healthStatus">å¥åº·ç‹€æ³</label>
                        <textarea id="healthStatus" name="healthStatus" rows="4" placeholder="è«‹è¼¸å…¥å®¢æˆ¶çš„å¥åº·ç‹€æ³..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="medications">æœç”¨è—¥ç‰©</label>
                        <textarea id="medications" name="medications" rows="4" placeholder="è«‹è¼¸å…¥æœç”¨çš„è—¥ç‰©..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="supplements">æœç”¨ä¿å¥é£Ÿå“</label>
                        <textarea id="supplements" name="supplements" rows="4" placeholder="è«‹è¼¸å…¥æœç”¨çš„ä¿å¥é£Ÿå“..."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">æ›´æ–°å®¢æˆ¶</button>
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='customers.html'">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/script.js"></script>
    <script>
        let currentCustomerId = null;

        // å¾ URL åƒæ•¸ç²å–å®¢æˆ¶ ID
        function getCustomerIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // è¼‰å…¥å®¢æˆ¶è³‡æ–™
        async function loadCustomerData() {
            const customerId = getCustomerIdFromUrl();
            if (!customerId) {
                alert('ç¼ºå°‘å®¢æˆ¶ IDï¼Œå°‡è¿”å›å®¢æˆ¶åˆ—è¡¨');
                window.location.href = 'customers.html';
                return;
            }

            currentCustomerId = customerId;
            document.getElementById('customerId').value = customerId;

            try {
                const customer = await getCustomerById(customerId);
                if (!customer) {
                    alert('æ‰¾ä¸åˆ°å®¢æˆ¶è³‡æ–™ï¼Œå°‡è¿”å›å®¢æˆ¶åˆ—è¡¨');
                    window.location.href = 'customers.html';
                    return;
                }

                // å¡«å…¥è¡¨å–®è³‡æ–™
                document.getElementById('name').value = customer.name || '';
                document.getElementById('phone').value = customer.phone || '';
                document.getElementById('city').value = customer.city || '';
                
                // æ›´æ–°é„‰é®å¸‚å€é¸å–®
                if (customer.city) {
                    updateDistricts();
                    // ç­‰å¾…é¸å–®æ›´æ–°å¾Œå†è¨­ç½®å€¼
                    setTimeout(() => {
                        document.getElementById('district').value = customer.district || '';
                    }, 100);
                }
                
                document.getElementById('village').value = customer.village || '';
                document.getElementById('neighborhood').value = customer.neighborhood || '';
                document.getElementById('streetType').value = customer.streetType || '';
                document.getElementById('streetName').value = customer.streetName || '';
                document.getElementById('lane').value = customer.lane || '';
                document.getElementById('alley').value = customer.alley || '';
                document.getElementById('number').value = customer.number || '';
                document.getElementById('floor').value = customer.floor || '';
                document.getElementById('addressDetail').value = customer.fullAddress || '';
                document.getElementById('healthStatus').value = customer.healthStatus || '';
                document.getElementById('medications').value = customer.medications || '';
                document.getElementById('supplements').value = customer.supplements || '';
                
                // é¡¯ç¤ºé ­åƒ
                if (customer.avatar) {
                    const avatarPreview = document.getElementById('avatarPreview');
                    avatarPreview.innerHTML = `<img src="${customer.avatar}" alt="å®¢æˆ¶é ­åƒ">`;
                }

                // æ›´æ–°åœ°å€é è¦½
                updateAddressPreview();
            } catch (error) {
                alert('è¼‰å…¥å®¢æˆ¶è³‡æ–™å¤±æ•—ï¼š' + error.message);
                console.error('Load customer error:', error);
            }
        }

        // è™•ç†è¡¨å–®æäº¤
        async function handleSubmit(event) {
            event.preventDefault();
            
            if (!currentCustomerId) {
                alert('ç¼ºå°‘å®¢æˆ¶ ID');
                return;
            }
            
            // å–å¾—è¡¨å–®è³‡æ–™
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const city = document.getElementById('city').value;
            const district = document.getElementById('district').value;
            const village = document.getElementById('village').value.trim();
            const neighborhood = document.getElementById('neighborhood').value.trim();
            const streetType = document.getElementById('streetType').value;
            const streetName = document.getElementById('streetName').value.trim();
            const lane = document.getElementById('lane').value.trim();
            const alley = document.getElementById('alley').value.trim();
            const number = document.getElementById('number').value.trim();
            const floor = document.getElementById('floor').value.trim();
            const addressDetail = document.getElementById('addressDetail').value.trim();
            const healthStatus = document.getElementById('healthStatus').value.trim();
            const medications = document.getElementById('medications').value.trim();
            const supplements = document.getElementById('supplements').value.trim();
            
            if (!name || !phone || !city || !district) {
                alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼ˆå§“åã€é›»è©±ã€ç¸£å¸‚ã€é„‰é®å¸‚å€ï¼‰');
                return;
            }
            
            // çµ„åˆå®Œæ•´åœ°å€
            const fullAddress = addressDetail || buildFullAddress();
            
            // å–å¾—é ­åƒ
            const avatarFile = document.getElementById('avatar').files[0];
            let avatar = '';
            
            // å¦‚æœæœ‰ç¾æœ‰é ­åƒä¸”æ²’æœ‰é¸æ“‡æ–°é ­åƒï¼Œä¿ç•™ç¾æœ‰é ­åƒ
            const avatarPreview = document.getElementById('avatarPreview');
            if (!avatarFile && avatarPreview.querySelector('img')) {
                avatar = avatarPreview.querySelector('img').src;
            }
            
            if (avatarFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    avatar = e.target.result;
                    await updateCustomerData(currentCustomerId, name, phone, city, district, village, neighborhood, streetType, streetName, lane, alley, number, floor, fullAddress, healthStatus, medications, supplements, avatar);
                };
                reader.readAsDataURL(avatarFile);
            } else {
                await updateCustomerData(currentCustomerId, name, phone, city, district, village, neighborhood, streetType, streetName, lane, alley, number, floor, fullAddress, healthStatus, medications, supplements, avatar);
            }
        }

        // æ›´æ–°å®¢æˆ¶è³‡æ–™
        async function updateCustomerData(customerId, name, phone, city, district, village, neighborhood, streetType, streetName, lane, alley, number, floor, fullAddress, healthStatus, medications, supplements, avatar) {
            try {
                // å»ºç«‹å®¢æˆ¶ç‰©ä»¶
                const customerData = {
                    name: name,
                    phone: phone,
                    city: city,
                    district: district,
                    village: village || '',
                    neighborhood: neighborhood || '',
                    streetType: streetType || '',
                    streetName: streetName || '',
                    lane: lane || '',
                    alley: alley || '',
                    number: number || '',
                    floor: floor || '',
                    fullAddress: fullAddress || '',
                    healthStatus: healthStatus || '',
                    medications: medications || '',
                    supplements: supplements || '',
                    avatar: avatar || ''
                };
                
                // é¡¯ç¤ºè¼‰å…¥ä¸­
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'æ›´æ–°ä¸­...';
                
                // å‘¼å« API æ›´æ–°å®¢æˆ¶
                await updateCustomer(customerId, customerData);
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ä¸¦è¿”å›
                alert('å®¢æˆ¶è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼');
                window.location.href = 'customers.html';
            } catch (error) {
                alert('æ›´æ–°å®¢æˆ¶å¤±æ•—ï¼š' + error.message);
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'æ›´æ–°å®¢æˆ¶';
                console.error('Update customer error:', error);
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async function() {
            checkAuth();
            initCitySelect();
            await loadCustomerData();
            setupAddressListeners();
        });
    </script>
</body>
</html>

