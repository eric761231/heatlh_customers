<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <title>登入系統</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <h1>葡眾愛客戶</h1>
            <p class="login-subtitle">請使用 Google 帳號登入</p>
            
            <div id="g_id_signin" class="g_id_signin"></div>
            
            <div id="loginStatus" class="login-status"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script>
        // 檢查是否已登入
        function checkLoginStatus() {
            // 如果 URL 中有 logout 參數，清除所有登入狀態
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('logout') === 'true') {
                // 清除所有登入資訊
                localStorage.removeItem('googleLogin');
                
                // 清除快取
                if (typeof window !== 'undefined' && typeof window.dataCache !== 'undefined') {
                    window.dataCache = null;
                }
                if (typeof window !== 'undefined' && typeof window.currentUser !== 'undefined') {
                    window.currentUser = null;
                }
                
                // 清除 URL 參數
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // 強制重新初始化 Google Sign-In
                setTimeout(() => {
                    initializeGoogleSignIn();
                }, 100);
                return;
            }
            
            const loginInfo = localStorage.getItem('googleLogin');
            if (loginInfo) {
                try {
                    const userInfo = JSON.parse(loginInfo);
                    if (userInfo.email && userInfo.exp) {
                        // 檢查是否過期（24小時）
                        const now = Date.now();
                        if (now < userInfo.exp) {
                            // 已登入且未過期，直接跳轉
                            window.location.href = 'calendar.html';
                            return;
                        } else {
                            // 已過期，清除登入資訊
                            localStorage.removeItem('googleLogin');
                        }
                    }
                } catch (e) {
                    localStorage.removeItem('googleLogin');
                }
            }
        }

        // Base64 URL-safe 解碼函數
        function base64UrlDecode(str) {
            // 將 base64url 轉換為標準 base64
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            
            // 添加填充
            while (str.length % 4) {
                str += '=';
            }
            
            try {
                // 解碼 base64
                return atob(str);
            } catch (e) {
                console.error('Base64 解碼錯誤:', e);
                throw e;
            }
        }

        // 處理 Google 登入回應
        async function handleCredentialResponse(response) {
            const statusDiv = document.getElementById('loginStatus');
            
            console.log('Google 登入回應:', response);
            
            // 檢查回應格式
            if (!response || !response.credential) {
                statusDiv.innerHTML = '<div class="error-message">登入回應格式錯誤，請重試</div>';
                console.error('無效的登入回應:', response);
                return;
            }
            
            try {
                // 分割 JWT token（格式：header.payload.signature）
                const parts = response.credential.split('.');
                if (parts.length !== 3) {
                    throw new Error('JWT token 格式錯誤');
                }
                
                // 解碼 payload（第二部分）
                const decodedPayload = base64UrlDecode(parts[1]);
                const payload = JSON.parse(decodedPayload);
                
                console.log('解碼後的 payload:', payload);
                
                // 驗證必要的欄位
                if (!payload.email) {
                    throw new Error('缺少 email 資訊');
                }
                
                // 清除所有舊的登入資訊和快取（確保可以切換帳號）
                // 強制清除所有相關的 localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('googleLogin') || key.includes('cache'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // 清除客戶資料快取（如果存在）
                if (typeof window !== 'undefined' && typeof window.dataCache !== 'undefined') {
                    window.dataCache = null;
                }
                
                // 清除當前使用者快取
                if (typeof window !== 'undefined' && typeof window.currentUser !== 'undefined') {
                    window.currentUser = null;
                }
                
                // 儲存新的登入資訊
                const loginInfo = {
                    email: payload.email,
                    name: payload.name || payload.given_name || '使用者',
                    picture: payload.picture || '',
                    googleId: payload.sub || '', // Google 使用者 ID
                    exp: Date.now() + (24 * 60 * 60 * 1000) // 24小時後過期
                };
                
                localStorage.setItem('googleLogin', JSON.stringify(loginInfo));
                
                // 如果使用 Supabase，儲存使用者到資料庫
                if (typeof DATA_SOURCE !== 'undefined' && DATA_SOURCE === 'supabase' && typeof createOrUpdateUser !== 'undefined') {
                    try {
                        await createOrUpdateUser({
                            email: payload.email,
                            name: payload.name || payload.given_name || '使用者',
                            picture: payload.picture || '',
                            googleId: payload.sub || ''
                        });
                        console.log('使用者資料已儲存到 Supabase');
                    } catch (error) {
                        console.error('儲存使用者資料失敗:', error);
                        // 即使儲存失敗也繼續登入流程
                    }
                }
                
                statusDiv.innerHTML = '<div class="success-message">登入成功！正在跳轉...</div>';
                
                // 跳轉到主頁面
                setTimeout(() => {
                    window.location.href = 'calendar.html';
                }, 1000);
            } catch (error) {
                statusDiv.innerHTML = '<div class="error-message">登入失敗：' + error.message + '</div>';
                console.error('登入錯誤:', error);
                console.error('回應內容:', response);
            }
        }

        // 初始化 Google Sign-In
        function initializeGoogleSignIn() {
            // 檢查 Client ID 是否已設定
            if (typeof GOOGLE_CLIENT_ID === 'undefined' || !GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
                document.getElementById('loginStatus').innerHTML = 
                    '<div class="error-message">請在 config.js 中設定 GOOGLE_CLIENT_ID</div>';
                return;
            }

            // 載入 Google Sign-In 腳本
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            script.onload = function() {
                // 確保 Google Sign-In 已載入後再初始化
                if (window.google && window.google.accounts && window.google.accounts.id) {
                    try {
                        window.google.accounts.id.initialize({
                            client_id: GOOGLE_CLIENT_ID,
                            callback: handleCredentialResponse,
                            auto_select: false,
                            cancel_on_tap_outside: true
                        });
                        
                        // 渲染登入按鈕
                        const signinButton = document.getElementById('g_id_signin');
                        if (signinButton) {
                            window.google.accounts.id.renderButton(signinButton, {
                                type: 'standard',
                                size: 'large',
                                theme: 'outline',
                                text: 'sign_in_with',
                                shape: 'rectangular',
                                logo_alignment: 'left'
                            });
                        }
                    } catch (error) {
                        console.error('Google Sign-In 初始化錯誤:', error);
                        document.getElementById('loginStatus').innerHTML = 
                            '<div class="error-message">初始化登入功能失敗，請重新整理頁面</div>';
                    }
                } else {
                    console.error('Google Sign-In 腳本未正確載入');
                    document.getElementById('loginStatus').innerHTML = 
                        '<div class="error-message">無法載入 Google 登入服務，請檢查網路連線</div>';
                }
            };
            script.onerror = function() {
                console.error('無法載入 Google Sign-In 腳本');
                document.getElementById('loginStatus').innerHTML = 
                    '<div class="error-message">無法載入 Google 登入服務，請檢查網路連線</div>';
            };
            document.head.appendChild(script);
        }

        // 頁面載入時檢查登入狀態並初始化
        window.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            initializeGoogleSignIn();
        });
    </script>
</body>
</html>

