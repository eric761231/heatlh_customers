<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å…¥ç³»çµ±</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body class="login-page">
    <div class="login-header">
        <button class="back-btn" onclick="window.history.back()" style="display: none;" id="backBtn">
            <span>â†</span> è¿”å›
        </button>
        <h1 class="welcome-title" id="welcomeTitle">æ­¡è¿å›ä¾†ï¼Œè‘¡çœ¾æ„›å®¢æˆ¶</h1>
    </div>
    
    <div class="login-content-card">
        <h2 class="login-title">ç™»å…¥</h2>
        
        <div id="status" class="login-status"></div>
        
        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group-modern">
                <input type="email" id="email" name="email" required placeholder="Your email" autocomplete="email" class="modern-input">
            </div>
            
            <div class="form-group-modern">
                <input type="password" id="password" name="password" required placeholder="Password" autocomplete="current-password" class="modern-input">
                <a href="forgot-password.html" class="forgot-password">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
            </div>
            
            <button type="submit" class="btn-login-gradient">
                ç™»å…¥
            </button>
        </form>
        
        <div class="signup-link">
            <span>é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ</span>
            <a href="register.html">ç«‹å³è¨»å†Š</a>
        </div>
    </div>

    <script>
        // ä½¿ç”¨ supabase-client.js ä¸­å·²æä¾›çš„ initSupabase å‡½æ•¸
        // ä¸éœ€è¦é‡æ–°å®£å‘Š supabaseClientï¼Œå› ç‚º supabase-client.js å·²ç¶“æä¾›äº†

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        async function checkLoginStatus() {
            const client = initSupabase();
            if (!client) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æœƒè©±
            const { data: { session }, error } = await client.auth.getSession();
            
            if (session && session.user) {
                // å·²ç™»å…¥ï¼Œè·³è½‰åˆ°ä¸»é 
                window.location.href = 'calendar.html';
                return;
            }
            
            // æ›´æ–°æ­¡è¿æ¨™é¡Œï¼ˆå¦‚æœæœ‰ä½¿ç”¨è€…åç¨±ï¼‰
            // åªæœ‰åœ¨å·²ç™»å…¥æ™‚æ‰æŸ¥è©¢ç”¨æˆ¶è³‡æ–™
            if (session && session.user && session.user.id) {
                try {
                    const { data: userData } = await client
                        .from('users')
                        .select('name')
                        .eq('id', session.user.id)
                        .maybeSingle(); // ä½¿ç”¨ maybeSingle() é¿å… 406 éŒ¯èª¤
                    
                    if (userData && userData.name) {
                        document.getElementById('welcomeTitle').textContent = `æ­¡è¿å›ä¾†ï¼Œ${userData.name}`;
                    }
                } catch (e) {
                    // å¿½ç•¥éŒ¯èª¤ï¼Œä¸å½±éŸ¿é é¢è¼‰å…¥
                    console.warn('æŸ¥è©¢ç”¨æˆ¶åç¨±æ™‚å‡ºéŒ¯:', e);
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è¿”å›æŒ‰éˆ•éœ€è¦é¡¯ç¤º
            if (document.referrer && document.referrer.includes('register.html')) {
                document.getElementById('backBtn').style.display = 'block';
            }
            
            // æª¢æŸ¥ URL åƒæ•¸
            const urlParams = new URLSearchParams(window.location.search);
            const statusDiv = document.getElementById('status');
            
            if (urlParams.get('registered') === 'true') {
                statusDiv.innerHTML = '<div class="success-message">è¨»å†ŠæˆåŠŸï¼<br><br>ğŸ“§ è«‹æª¢æŸ¥æ‚¨çš„ Email æ”¶ä»¶åŒ£ï¼ˆåŒ…æ‹¬åƒåœ¾éƒµä»¶è³‡æ–™å¤¾ï¼‰ä¸¦é»æ“Šé©—è­‰é€£çµã€‚<br><br>ğŸ’¡ éƒµä»¶å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ‰èƒ½é€é”ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚<br><br>é©—è­‰å®Œæˆå¾Œå³å¯ç™»å…¥ã€‚</div>';
            } else if (urlParams.get('passwordReset') === 'true') {
                statusDiv.innerHTML = '<div class="success-message">å¯†ç¢¼é‡ç½®æˆåŠŸï¼è«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥</div>';
            }
        }

        // è™•ç†ç™»å…¥
        async function handleLogin(event) {
            event.preventDefault();
            
            const statusDiv = document.getElementById('status');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // ç²å–è¡¨å–®è³‡æ–™
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            // é©—è­‰
            if (!email || !password) {
                statusDiv.innerHTML = '<div class="error-message">è«‹å¡«å¯« Email å’Œå¯†ç¢¼</div>';
                return;
            }
            
            // é©—è­‰ email æ ¼å¼
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                statusDiv.innerHTML = '<div class="error-message">Email æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥å¾Œé‡è©¦</div>';
                return;
            }
            
            // é©—è­‰å¯†ç¢¼é•·åº¦
            if (password.length < 6) {
                statusDiv.innerHTML = '<div class="error-message">å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ</div>';
                return;
            }
            
            console.log('é–‹å§‹ç™»å…¥æµç¨‹ï¼ŒEmail:', email, 'å¯†ç¢¼é•·åº¦:', password.length);
            
            // åˆå§‹åŒ– Supabase
            const client = initSupabase();
            if (!client) {
                statusDiv.innerHTML = '<div class="error-message">ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç™»å…¥ä¸­...';
            statusDiv.innerHTML = '<div style="color: #6B7280; padding: 12px; text-align: center;">æ­£åœ¨ç™»å…¥ï¼Œè«‹ç¨å€™...</div>';
            
            try {
                // ç™»å…¥
                console.log('å˜—è©¦ç™»å…¥ï¼ŒEmail:', email);
                const { data, error } = await client.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    console.error('ç™»å…¥éŒ¯èª¤è©³æƒ…:', error);
                    throw error;
                }
                
                if (!data || !data.user) {
                    console.error('ç™»å…¥å¤±æ•—ï¼šæœªæ”¶åˆ°ç”¨æˆ¶è³‡æ–™', data);
                    throw new Error('ç™»å…¥å¤±æ•—ï¼Œæœªæ”¶åˆ°ç”¨æˆ¶è³‡æ–™');
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ sessionï¼ˆé€™æ˜¯ç™»å…¥æˆåŠŸçš„å¿…è¦æ¢ä»¶ï¼‰
                if (!data.session) {
                    console.warn('ç™»å…¥å¤±æ•—ï¼šæ²’æœ‰ session', data);
                    // æª¢æŸ¥æ˜¯å¦éœ€è¦ email ç¢ºèª
                    if (data.user && !data.user.email_confirmed_at) {
                        throw new Error('è«‹å…ˆç¢ºèªæ‚¨çš„ Emailã€‚è«‹æª¢æŸ¥æ‚¨çš„æ”¶ä»¶åŒ£ä¸¦é»æ“Šç¢ºèªé€£çµã€‚');
                    } else {
                        throw new Error('ç™»å…¥å¤±æ•—ï¼šç„¡æ³•å»ºç«‹æœƒè©±ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«ç®¡ç†å“¡');
                    }
                }
                
                console.log('ç™»å…¥æˆåŠŸï¼Œç”¨æˆ¶ ID:', data.user.id, 'Session:', data.session ? 'å·²å»ºç«‹' : 'æœªå»ºç«‹');
                
                // ç™»å…¥æˆåŠŸï¼Œæ›´æ–°ç”¨æˆ¶è³‡æ–™åˆ° users è¡¨ï¼ˆç¢ºä¿ user_login æ­£ç¢ºè¨­å®šï¼‰
                try {
                    // å…ˆæŸ¥è©¢æ˜¯å¦å·²æœ‰ç”¨æˆ¶è³‡æ–™ï¼ˆä½¿ç”¨ try-catch è™•ç†å¯èƒ½çš„ 406 éŒ¯èª¤ï¼‰
                    let existingUser = null;
                    try {
                        const { data, error: checkError } = await client
                            .from('users')
                            .select('user_login, name')
                            .eq('id', data.user.id)
                            .maybeSingle(); // ä½¿ç”¨ maybeSingle() è€Œä¸æ˜¯ single()ï¼Œé¿å… 406 éŒ¯èª¤
                        
                        if (!checkError && data) {
                            existingUser = data;
                        }
                    } catch (checkErr) {
                        console.warn('æŸ¥è©¢ç”¨æˆ¶è³‡æ–™æ™‚å‡ºéŒ¯ï¼ˆä¸å½±éŸ¿ç™»å…¥ï¼‰:', checkErr);
                        // å¿½ç•¥æŸ¥è©¢éŒ¯èª¤ï¼Œç¹¼çºŒåŸ·è¡Œ
                    }
                    
                    // å¦‚æœæ²’æœ‰ user_loginï¼Œä½¿ç”¨ email ä½œç‚ºé è¨­å€¼
                    const userLogin = existingUser?.user_login || data.user.email;
                    const userName = existingUser?.name || data.user.user_metadata?.name || data.user.email?.split('@')[0] || 'ä½¿ç”¨è€…';
                    
                    // å˜—è©¦æ›´æ–° users è¡¨ï¼ˆå¦‚æœå¤±æ•—ä¹Ÿä¸é˜»æ­¢ç™»å…¥ï¼‰
                    try {
                        const { data: userData, error: userError } = await client
                            .from('users')
                            .upsert({
                                id: data.user.id,
                                user_login: userLogin, // ç¢ºä¿ user_login æ­£ç¢ºè¨­å®š
                                name: userName,
                                last_login: new Date().toISOString()
                            }, { onConflict: 'id' })
                            .select()
                            .maybeSingle(); // ä½¿ç”¨ maybeSingle() é¿å…éŒ¯èª¤
                        
                        if (userError) {
                            console.error('æ›´æ–°ç”¨æˆ¶è³‡æ–™å¤±æ•—:', userError);
                            // é¡¯ç¤ºéŒ¯èª¤ä½†ä¸é˜»æ­¢ç™»å…¥
                            if (userError.message && (userError.message.includes('permission') || userError.message.includes('policy') || userError.message.includes('RLS'))) {
                                console.warn('è³‡æ–™åº«æ¬Šé™å•é¡Œï¼Œè«‹æª¢æŸ¥ RLS æ”¿ç­–');
                            }
                        } else {
                            console.log('ç”¨æˆ¶è³‡æ–™å·²æˆåŠŸæ›´æ–°:', userData);
                        }
                    } catch (upsertErr) {
                        console.warn('æ›´æ–°ç”¨æˆ¶è³‡æ–™æ™‚å‡ºéŒ¯ï¼ˆä¸å½±éŸ¿ç™»å…¥ï¼‰:', upsertErr);
                        // ä¸é˜»æ­¢ç™»å…¥ï¼Œä½†è¨˜éŒ„éŒ¯èª¤
                    }
                } catch (e) {
                    console.error('è™•ç†ç”¨æˆ¶è³‡æ–™æ™‚å‡ºéŒ¯ï¼ˆä¸å½±éŸ¿ç™»å…¥ï¼‰:', e);
                    // ä¸é˜»æ­¢ç™»å…¥ï¼Œä½†è¨˜éŒ„éŒ¯èª¤
                }
                
                // é©—è­‰ session æ˜¯å¦çœŸçš„æœ‰æ•ˆ
                const sessionCheck = await client.auth.getSession();
                if (!sessionCheck.data.session) {
                    console.error('Session é©—è­‰å¤±æ•—ï¼Œsession ä¸å­˜åœ¨');
                    throw new Error('ç™»å…¥æœƒè©±é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
                }
                
                // ç™»å…¥æˆåŠŸ
                console.log('ç™»å…¥æˆåŠŸï¼Œæº–å‚™è·³è½‰åˆ°ä¸»é é¢');
                console.log('Session é©—è­‰é€šéï¼Œç”¨æˆ¶:', sessionCheck.data.session.user.email);
                statusDiv.innerHTML = '<div class="success-message">ç™»å…¥æˆåŠŸï¼æ­£åœ¨è·³è½‰...</div>';
                
                // ç¢ºä¿è·³è½‰åŸ·è¡Œ
                setTimeout(() => {
                    console.log('åŸ·è¡Œè·³è½‰åˆ° calendar.html');
                    window.location.href = 'calendar.html';
                }, 1000);
                
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    status: error.status,
                    code: error.code,
                    error: error
                });
                
                let errorMessage = 'ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦';
                let debugInfo = '';
                
                if (error.message) {
                    // æ›´ç²¾ç¢ºçš„éŒ¯èª¤è¨Šæ¯è™•ç†
                    const errMsg = error.message.toLowerCase();
                    
                    if (errMsg.includes('email logins are disabled') || 
                        errMsg.includes('email provider is disabled')) {
                        errorMessage = 'Email ç™»å…¥åŠŸèƒ½å·²è¢«é—œé–‰';
                        debugInfo = `
                            <br><br><strong>âŒ å•é¡Œï¼š</strong> Supabase çš„ Email Provider å·²è¢«é—œé–‰<br><br>
                            <strong>ğŸ”§ è§£æ±ºæ­¥é©Ÿï¼š</strong><br>
                            <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                                <li>å‰å¾€ <a href="https://app.supabase.com/" target="_blank" style="color: #4F46E5;">Supabase Dashboard</a></li>
                                <li>é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ</li>
                                <li>å‰å¾€ <strong>Authentication</strong> > <strong>Providers</strong> > <strong>Email</strong></li>
                                <li>é–‹å•Ÿ <strong>Enable email provider</strong> é¸é …</li>
                                <li>ä¿å­˜è¨­å®š</li>
                                <li>é‡æ–°å˜—è©¦ç™»å…¥</li>
                            </ol>
                            <br><strong>ğŸ’¡ æ³¨æ„ï¼š</strong> Email Provider å¿…é ˆå•Ÿç”¨æ‰èƒ½ä½¿ç”¨ Email ç™»å…¥ã€è¨»å†Šå’Œé‡ç½®å¯†ç¢¼åŠŸèƒ½ã€‚
                        `;
                    } else if (errMsg.includes('invalid login credentials') || 
                        errMsg.includes('invalid credentials') ||
                        errMsg.includes('email or password') ||
                        errMsg.includes('wrong password')) {
                        errorMessage = 'Email æˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œé‡è©¦';
                        debugInfo = `
                            <br><br><strong>ğŸ’¡ è¨ºæ–·æ­¥é©Ÿï¼š</strong><br>
                            <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                                <li>ç¢ºèª Email åœ°å€æ˜¯å¦æ­£ç¢ºï¼š<code>${email}</code></li>
                                <li>ç¢ºèªå¯†ç¢¼æ˜¯å¦æ­£ç¢ºï¼ˆæ³¨æ„å¤§å°å¯«ï¼‰</li>
                                <li>æª¢æŸ¥æ­¤ Email æ˜¯å¦å·²è¨»å†Š</li>
                                <li>å¦‚æœå‰›è¨»å†Šï¼Œè«‹ç¢ºèªè¨»å†Šæ˜¯å¦æˆåŠŸ</li>
                                <li>å‰å¾€ <a href="register.html" style="color: #4F46E5;">è¨»å†Šé é¢</a> å˜—è©¦é‡æ–°è¨»å†Š</li>
                            </ol>
                            <br><strong>ğŸ” æª¢æŸ¥æ¸…å–®ï¼š</strong><br>
                            <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
                                <li>å‰å¾€ <a href="https://app.supabase.com/" target="_blank" style="color: #4F46E5;">Supabase Dashboard</a> > Authentication > Users</li>
                                <li>æª¢æŸ¥ Email <code>${email}</code> æ˜¯å¦å­˜åœ¨</li>
                                <li>æª¢æŸ¥ <strong>Authentication</strong> > <strong>Providers</strong> > <strong>Email</strong> ä¸­çš„ <strong>Enable email provider</strong> æ˜¯å¦é–‹å•Ÿ</li>
                                <li>å¦‚æœä¸å­˜åœ¨ï¼Œè«‹é‡æ–°è¨»å†Š</li>
                                <li>å¦‚æœå­˜åœ¨ä½†ç„¡æ³•ç™»å…¥ï¼Œè«‹æª¢æŸ¥ Supabase è¨­å®š</li>
                            </ul>
                        `;
                    } else if (errMsg.includes('email not confirmed') || 
                               errMsg.includes('email confirmation') ||
                               errMsg.includes('è«‹å…ˆç¢ºèªæ‚¨çš„ email')) {
                        errorMessage = 'è«‹å…ˆç¢ºèªæ‚¨çš„ Emailã€‚è«‹æª¢æŸ¥æ‚¨çš„æ”¶ä»¶åŒ£ä¸¦é»æ“Šç¢ºèªé€£çµã€‚';
                    } else if (errMsg.includes('user not found') || 
                               errMsg.includes('user does not exist')) {
                        errorMessage = 'æ­¤ Email å°šæœªè¨»å†Šï¼Œè«‹å…ˆè¨»å†Šå¸³è™Ÿ';
                        debugInfo = `<br><br><a href="register.html" style="color: #4F46E5;">â†’ å‰å¾€è¨»å†Šé é¢</a>`;
                    } else if (errMsg.includes('too many requests') || 
                               errMsg.includes('rate limit')) {
                        errorMessage = 'ç™»å…¥å˜—è©¦éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦';
                    } else if (errMsg.includes('session') || 
                               errMsg.includes('æœƒè©±')) {
                        errorMessage = 'ç„¡æ³•å»ºç«‹ç™»å…¥æœƒè©±ï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œé‡è©¦';
                    } else {
                        errorMessage = error.message;
                    }
                } else if (error.status) {
                    // è™•ç† HTTP ç‹€æ…‹ç¢¼
                    if (error.status === 400) {
                        errorMessage = 'Email æˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œé‡è©¦';
                        debugInfo = `<br><br>ğŸ’¡ æç¤ºï¼šç¢ºèª Email å’Œå¯†ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–å‰å¾€ <a href="register.html" style="color: #4F46E5;">è¨»å†Šé é¢</a> é‡æ–°è¨»å†Š`;
                    } else if (error.status === 401) {
                        errorMessage = 'Email æˆ–å¯†ç¢¼éŒ¯èª¤';
                        debugInfo = `<br><br>ğŸ’¡ æç¤ºï¼šç¢ºèª Email å’Œå¯†ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–å‰å¾€ <a href="register.html" style="color: #4F46E5;">è¨»å†Šé é¢</a> é‡æ–°è¨»å†Š`;
                    } else if (error.status === 429) {
                        errorMessage = 'ç™»å…¥å˜—è©¦éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦';
                    } else if (error.status >= 500) {
                        errorMessage = 'ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
                    }
                }
                
                statusDiv.innerHTML = `<div class="error-message">${errorMessage}${debugInfo}</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = 'ç™»å…¥';
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥
        window.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
</body>
</html>
