<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登入系統</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body class="login-page">
    <div class="login-header">
        <button class="back-btn" onclick="window.history.back()" style="display: none;" id="backBtn">
            <span>←</span> 返回
        </button>
        <button class="skip-btn" onclick="window.location.href='calendar.html'">Skip</button>
        <h1 class="welcome-title" id="welcomeTitle">歡迎回來，葡眾愛客戶</h1>
    </div>
    
    <div class="login-content-card">
        <h2 class="login-title">登入</h2>
        
        <div id="status" class="login-status"></div>
        
        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group-modern">
                <input type="email" id="email" name="email" required placeholder="Your email" autocomplete="email" class="modern-input">
            </div>
            
            <div class="form-group-modern">
                <input type="password" id="password" name="password" required placeholder="Password" autocomplete="current-password" class="modern-input">
                <a href="forgot-password.html" class="forgot-password">忘記密碼？</a>
            </div>
            
            <button type="submit" class="btn-login-gradient">
                登入
            </button>
        </form>
        
        <div class="signup-link">
            <span>還沒有帳號？</span>
            <a href="register.html">立即註冊</a>
        </div>
    </div>

    <script>
        // 使用 supabase-client.js 中已提供的 initSupabase 函數
        // 不需要重新宣告 supabaseClient，因為 supabase-client.js 已經提供了

        // 檢查登入狀態
        async function checkLoginStatus() {
            const client = initSupabase();
            if (!client) return;
            
            // 檢查是否有有效的會話
            const { data: { session }, error } = await client.auth.getSession();
            
            if (session && session.user) {
                // 已登入，跳轉到主頁
                window.location.href = 'calendar.html';
                return;
            }
            
            // 更新歡迎標題（如果有使用者名稱）
            try {
                const { data: userData } = await client
                    .from('users')
                    .select('name')
                    .eq('id', session?.user?.id || '')
                    .single();
                
                if (userData && userData.name) {
                    document.getElementById('welcomeTitle').textContent = `歡迎回來，${userData.name}`;
                }
            } catch (e) {
                // 忽略錯誤
            }
            
            // 檢查是否有返回按鈕需要顯示
            if (document.referrer && document.referrer.includes('register.html')) {
                document.getElementById('backBtn').style.display = 'block';
            }
            
            // 檢查 URL 參數
            const urlParams = new URLSearchParams(window.location.search);
            const statusDiv = document.getElementById('status');
            
            if (urlParams.get('registered') === 'true') {
                statusDiv.innerHTML = '<div class="success-message">註冊成功！請使用您的 Email 和密碼登入</div>';
            } else if (urlParams.get('passwordReset') === 'true') {
                statusDiv.innerHTML = '<div class="success-message">密碼重置成功！請使用新密碼登入</div>';
            }
        }

        // 處理登入
        async function handleLogin(event) {
            event.preventDefault();
            
            const statusDiv = document.getElementById('status');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // 獲取表單資料
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            // 驗證
            if (!email || !password) {
                statusDiv.innerHTML = '<div class="error-message">請填寫 Email 和密碼</div>';
                return;
            }
            
            // 驗證 email 格式
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                statusDiv.innerHTML = '<div class="error-message">Email 格式不正確，請檢查後重試</div>';
                return;
            }
            
            // 驗證密碼長度
            if (password.length < 6) {
                statusDiv.innerHTML = '<div class="error-message">密碼長度至少需要 6 個字元</div>';
                return;
            }
            
            console.log('開始登入流程，Email:', email, '密碼長度:', password.length);
            
            // 初始化 Supabase
            const client = initSupabase();
            if (!client) {
                statusDiv.innerHTML = '<div class="error-message">系統初始化失敗，請重新整理頁面</div>';
                return;
            }
            
            // 顯示載入狀態
            submitBtn.disabled = true;
            submitBtn.textContent = '登入中...';
            statusDiv.innerHTML = '<div style="color: #6B7280; padding: 12px; text-align: center;">正在登入，請稍候...</div>';
            
            try {
                // 登入
                console.log('嘗試登入，Email:', email);
                const { data, error } = await client.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    console.error('登入錯誤詳情:', error);
                    throw error;
                }
                
                if (!data || !data.user) {
                    console.error('登入失敗：未收到用戶資料', data);
                    throw new Error('登入失敗，未收到用戶資料');
                }
                
                // 檢查是否有有效的 session（這是登入成功的必要條件）
                if (!data.session) {
                    console.warn('登入失敗：沒有 session', data);
                    // 檢查是否需要 email 確認
                    if (data.user && !data.user.email_confirmed_at) {
                        throw new Error('請先確認您的 Email。請檢查您的收件匣並點擊確認連結。');
                    } else {
                        throw new Error('登入失敗：無法建立會話，請稍後再試或聯繫管理員');
                    }
                }
                
                console.log('登入成功，用戶 ID:', data.user.id, 'Session:', data.session ? '已建立' : '未建立');
                
                // 登入成功，更新用戶資料到 users 表（確保 user_login 正確設定）
                try {
                    // 先查詢是否已有用戶資料
                    const { data: existingUser, error: checkError } = await client
                        .from('users')
                        .select('user_login, name')
                        .eq('id', data.user.id)
                        .single();
                    
                    // 如果沒有 user_login，使用 email 作為預設值
                    const userLogin = existingUser?.user_login || data.user.email;
                    const userName = existingUser?.name || data.user.user_metadata?.name || data.user.email?.split('@')[0] || '使用者';
                    
                    const { data: userData, error: userError } = await client
                        .from('users')
                        .upsert({
                            id: data.user.id,
                            user_login: userLogin, // 確保 user_login 正確設定
                            name: userName,
                            last_login: new Date().toISOString()
                        }, { onConflict: 'id' })
                        .select()
                        .single();
                    
                    if (userError) {
                        console.error('更新用戶資料失敗:', userError);
                        // 顯示錯誤但不阻止登入
                        if (userError.message && (userError.message.includes('permission') || userError.message.includes('policy') || userError.message.includes('RLS'))) {
                            console.warn('資料庫權限問題，請檢查 RLS 政策');
                        }
                    } else {
                        console.log('用戶資料已成功更新:', userData);
                    }
                } catch (e) {
                    console.error('更新用戶資料時出錯:', e);
                    // 不阻止登入，但記錄錯誤
                }
                
                // 驗證 session 是否真的有效
                const sessionCheck = await client.auth.getSession();
                if (!sessionCheck.data.session) {
                    console.error('Session 驗證失敗，session 不存在');
                    throw new Error('登入會話驗證失敗，請重新登入');
                }
                
                // 登入成功
                console.log('登入成功，準備跳轉到主頁面');
                console.log('Session 驗證通過，用戶:', sessionCheck.data.session.user.email);
                statusDiv.innerHTML = '<div class="success-message">登入成功！正在跳轉...</div>';
                
                // 確保跳轉執行
                setTimeout(() => {
                    console.log('執行跳轉到 calendar.html');
                    window.location.href = 'calendar.html';
                }, 1000);
                
            } catch (error) {
                console.error('登入錯誤:', error);
                let errorMessage = '登入失敗，請重試';
                
                if (error.message) {
                    // 更精確的錯誤訊息處理
                    const errMsg = error.message.toLowerCase();
                    
                    if (errMsg.includes('invalid login credentials') || 
                        errMsg.includes('invalid credentials') ||
                        errMsg.includes('email or password') ||
                        errMsg.includes('wrong password')) {
                        errorMessage = 'Email 或密碼錯誤，請檢查後重試';
                    } else if (errMsg.includes('email not confirmed') || 
                               errMsg.includes('email confirmation') ||
                               errMsg.includes('請先確認您的 email')) {
                        errorMessage = '請先確認您的 Email。請檢查您的收件匣並點擊確認連結。';
                    } else if (errMsg.includes('user not found') || 
                               errMsg.includes('user does not exist')) {
                        errorMessage = '此 Email 尚未註冊，請先註冊帳號';
                    } else if (errMsg.includes('too many requests') || 
                               errMsg.includes('rate limit')) {
                        errorMessage = '登入嘗試過於頻繁，請稍後再試';
                    } else if (errMsg.includes('session') || 
                               errMsg.includes('會話')) {
                        errorMessage = '無法建立登入會話，請重新整理頁面後重試';
                    } else {
                        errorMessage = error.message;
                    }
                } else if (error.status) {
                    // 處理 HTTP 狀態碼
                    if (error.status === 400) {
                        errorMessage = '請求格式錯誤，請檢查輸入的資料';
                    } else if (error.status === 401) {
                        errorMessage = 'Email 或密碼錯誤';
                    } else if (error.status === 429) {
                        errorMessage = '登入嘗試過於頻繁，請稍後再試';
                    } else if (error.status >= 500) {
                        errorMessage = '伺服器錯誤，請稍後再試';
                    }
                }
                
                statusDiv.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = '登入';
            }
        }

        // 頁面載入時檢查
        window.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
</body>
</html>
