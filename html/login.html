<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登入系統</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <h1>客戶健康狀況追蹤系統</h1>
            <p class="login-subtitle">請使用 Google 帳號登入</p>
            
            <div id="g_id_onload"
                 data-client_id=""
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            
            <div class="g_id_signin" 
                 data-type="standard"
                 data-size="large"
                 data-theme="outline"
                 data-text="sign_in_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>
            
            <div id="loginStatus" class="login-status"></div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // 檢查是否已登入
        function checkLoginStatus() {
            const loginInfo = localStorage.getItem('googleLogin');
            if (loginInfo) {
                try {
                    const userInfo = JSON.parse(loginInfo);
                    if (userInfo.email && userInfo.exp) {
                        // 檢查是否過期（24小時）
                        const now = Date.now();
                        if (now < userInfo.exp) {
                            // 已登入且未過期，直接跳轉
                            window.location.href = 'calendar.html';
                            return;
                        } else {
                            // 已過期，清除登入資訊
                            localStorage.removeItem('googleLogin');
                        }
                    }
                } catch (e) {
                    localStorage.removeItem('googleLogin');
                }
            }
        }

        // 處理 Google 登入回應
        function handleCredentialResponse(response) {
            const statusDiv = document.getElementById('loginStatus');
            
            // 驗證 token（這裡簡化處理，實際應在後端驗證）
            if (response.credential) {
                // 解碼 JWT token（簡化版，實際應使用後端驗證）
                try {
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    
                    // 儲存登入資訊
                    const loginInfo = {
                        email: payload.email,
                        name: payload.name,
                        picture: payload.picture,
                        exp: Date.now() + (24 * 60 * 60 * 1000) // 24小時後過期
                    };
                    
                    localStorage.setItem('googleLogin', JSON.stringify(loginInfo));
                    
                    statusDiv.innerHTML = '<div class="success-message">登入成功！正在跳轉...</div>';
                    
                    // 跳轉到主頁面
                    setTimeout(() => {
                        window.location.href = 'calendar.html';
                    }, 1000);
                } catch (error) {
                    statusDiv.innerHTML = '<div class="error-message">登入失敗，請重試</div>';
                    console.error('登入錯誤:', error);
                }
            }
        }

        // 設定 Google Client ID
        function setupGoogleSignIn() {
            if (typeof GOOGLE_CLIENT_ID !== 'undefined' && GOOGLE_CLIENT_ID && GOOGLE_CLIENT_ID !== 'YOUR_GOOGLE_CLIENT_ID_HERE') {
                const g_id_onload = document.getElementById('g_id_onload');
                if (g_id_onload) {
                    g_id_onload.setAttribute('data-client_id', GOOGLE_CLIENT_ID);
                }
            } else {
                document.getElementById('loginStatus').innerHTML = 
                    '<div class="error-message">請在 config.js 中設定 GOOGLE_CLIENT_ID</div>';
            }
        }

        // 頁面載入時檢查登入狀態
        window.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            setupGoogleSignIn();
        });
    </script>
</body>
</html>

