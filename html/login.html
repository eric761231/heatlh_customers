<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <title>ç™»å…¥ç³»çµ±</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <h1>è‘¡çœ¾æ„›å®¢æˆ¶</h1>
            <p class="login-subtitle">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
            
            <div id="g_id_signin" class="g_id_signin"></div>
            
            <button id="logoutBtn" class="btn-logout" onclick="logoutAccount()" style="display: none;">
                <span>ğŸšª</span>
                <span>ç™»å‡ºå¸³è™Ÿ</span>
            </button>
            
            <div id="loginStatus" class="login-status"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script>
        // æ¸…é™¤ Google Sign-In æœƒè©±
        function clearGoogleSignInSession() {
            try {
                if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                    // ç¦ç”¨è‡ªå‹•é¸æ“‡
                    google.accounts.id.disableAutoSelect();
                    // æ¸…é™¤æç¤º
                    google.accounts.id.cancel();
                    // æ¸…é™¤è¨˜ä½çš„å¸³è™Ÿ
                    google.accounts.id.storeCredential(null);
                }
            } catch (e) {
                console.log('æ¸…é™¤ Google Sign-In æœƒè©±æ™‚å‡ºéŒ¯:', e);
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰ç™»å…¥ç›¸é—œè³‡æ–™
        function clearAllLoginData() {
            console.log('é–‹å§‹æ¸…é™¤æ‰€æœ‰ç™»å…¥è³‡æ–™...');
            
            // 1. æ¸…é™¤ localStorage ä¸­çš„ç™»å…¥è³‡è¨Š
            localStorage.removeItem('googleLogin');
            console.log('âœ“ å·²æ¸…é™¤ localStorage.googleLogin');
            
            // 2. æ¸…é™¤æ‰€æœ‰ç›¸é—œçš„ localStorageï¼ˆåŒ…å« cacheï¼‰
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('googleLogin') || key.includes('cache') || key.includes('google') || key.includes('login'))) {
                    keysToRemove.push(key);
                    console.log('æ‰¾åˆ°ç›¸é—œéµ:', key);
                }
            }
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log('âœ“ å·²æ¸…é™¤ localStorage.' + key);
            });
            
            // 3. æ¸…é™¤ sessionStorageï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            try {
                sessionStorage.clear();
                console.log('âœ“ å·²æ¸…é™¤ sessionStorage');
            } catch (e) {
                console.log('æ¸…é™¤ sessionStorage æ™‚å‡ºéŒ¯:', e);
            }
            
            // 4. æ¸…é™¤ Google Sign-In æœƒè©±
            clearGoogleSignInSession();
            console.log('âœ“ å·²æ¸…é™¤ Google Sign-In æœƒè©±');
            
            // 5. æ¸…é™¤å¿«å–è®Šæ•¸
            if (typeof window !== 'undefined') {
                if (typeof window.dataCache !== 'undefined') {
                    window.dataCache = null;
                    console.log('âœ“ å·²æ¸…é™¤ window.dataCache');
                }
                if (typeof window.currentUser !== 'undefined') {
                    window.currentUser = null;
                    console.log('âœ“ å·²æ¸…é™¤ window.currentUser');
                }
            }
            
            // 6. å˜—è©¦æ¸…é™¤ Google ç›¸é—œçš„ Cookieï¼ˆå—é™æ–¼ç€è¦½å™¨å®‰å…¨ç­–ç•¥ï¼‰
            // æ³¨æ„ï¼šç”±æ–¼åŒæºæ”¿ç­–ï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥æ¸…é™¤ Google ç¶²åŸŸçš„ Cookie
            // ä½†å¯ä»¥é€šéæ¸…é™¤ Google Sign-In ç‹€æ…‹ä¾†é”åˆ°æ•ˆæœ
            
            console.log('æ‰€æœ‰ç™»å…¥è³‡æ–™å·²æ¸…é™¤å®Œæˆ');
        }
        
        // ç™»å‡ºå¸³è™ŸåŠŸèƒ½
        function logoutAccount() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºæ‰€æœ‰å¸³è™Ÿå—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰å·²å„²å­˜çš„ç™»å…¥è³‡è¨Šã€‚')) {
                clearAllLoginData();
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                const statusDiv = document.getElementById('loginStatus');
                statusDiv.innerHTML = '<div class="success-message">å·²æ¸…é™¤æ‰€æœ‰ç™»å…¥è³‡æ–™ï¼Œè«‹é‡æ–°ç™»å…¥</div>';
                
                // éš±è—ç™»å‡ºæŒ‰éˆ•
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.style.display = 'none';
                }
                
                // é‡æ–°åˆå§‹åŒ– Google Sign-In
                setTimeout(() => {
                    initializeGoogleSignIn();
                }, 500);
            }
        }
        
        // æª¢æŸ¥ä¸¦é¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
        function checkAndShowLogoutButton() {
            const loginInfo = localStorage.getItem('googleLogin');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (loginInfo && logoutBtn) {
                try {
                    const userInfo = JSON.parse(loginInfo);
                    if (userInfo.email) {
                        // æœ‰ç™»å…¥è³‡è¨Šï¼Œé¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
                        logoutBtn.style.display = 'flex';
                    } else {
                        logoutBtn.style.display = 'none';
                    }
                } catch (e) {
                    logoutBtn.style.display = 'none';
                }
            } else if (logoutBtn) {
                logoutBtn.style.display = 'none';
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        function checkLoginStatus() {
            // å¦‚æœ URL ä¸­æœ‰ logout åƒæ•¸ï¼Œæ¸…é™¤æ‰€æœ‰ç™»å…¥ç‹€æ…‹
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('logout') === 'true') {
                // æ¸…é™¤æ‰€æœ‰ç™»å…¥è³‡è¨Š
                localStorage.removeItem('googleLogin');
                
                // æ¸…é™¤æ‰€æœ‰ç›¸é—œçš„ localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('googleLogin') || key.includes('cache'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // æ¸…é™¤å¿«å–
                if (typeof window !== 'undefined' && typeof window.dataCache !== 'undefined') {
                    window.dataCache = null;
                }
                if (typeof window !== 'undefined' && typeof window.currentUser !== 'undefined') {
                    window.currentUser = null;
                }
                
                // æ¸…é™¤ Google Sign-In æœƒè©±
                clearGoogleSignInSession();
                
                // æ¸…é™¤ URL åƒæ•¸
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // å¼·åˆ¶é‡æ–°åˆå§‹åŒ– Google Sign-In
                setTimeout(() => {
                    initializeGoogleSignIn();
                }, 500);
                return;
            }
            
            const loginInfo = localStorage.getItem('googleLogin');
            if (loginInfo) {
                try {
                    const userInfo = JSON.parse(loginInfo);
                    if (userInfo.email && userInfo.exp) {
                        // æª¢æŸ¥æ˜¯å¦éæœŸï¼ˆ24å°æ™‚ï¼‰
                        const now = Date.now();
                        if (now < userInfo.exp) {
                            // å·²ç™»å…¥ä¸”æœªéæœŸï¼Œç›´æ¥è·³è½‰
                            window.location.href = 'calendar.html';
                            return;
                        } else {
                            // å·²éæœŸï¼Œæ¸…é™¤ç™»å…¥è³‡è¨Š
                            localStorage.removeItem('googleLogin');
                        }
                    }
                } catch (e) {
                    localStorage.removeItem('googleLogin');
                }
            }
            
            // å³ä½¿æ²’æœ‰ logout åƒæ•¸ï¼Œä¹Ÿæ¸…é™¤ä»»ä½•å·²å„²å­˜çš„ Google æœƒè©±
            // ç¢ºä¿æ¯æ¬¡é€²å…¥ç™»å…¥é é¢éƒ½è¦æ±‚é¸æ“‡å¸³è™Ÿ
            clearGoogleSignInSession();
        }

        // Base64 URL-safe è§£ç¢¼å‡½æ•¸
        function base64UrlDecode(str) {
            // å°‡ base64url è½‰æ›ç‚ºæ¨™æº– base64
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            
            // æ·»åŠ å¡«å……
            while (str.length % 4) {
                str += '=';
            }
            
            try {
                // è§£ç¢¼ base64
                return atob(str);
            } catch (e) {
                console.error('Base64 è§£ç¢¼éŒ¯èª¤:', e);
                throw e;
            }
        }

        // è™•ç† Google ç™»å…¥å›æ‡‰
        async function handleCredentialResponse(response) {
            const statusDiv = document.getElementById('loginStatus');
            
            console.log('Google ç™»å…¥å›æ‡‰:', response);
            
            // æª¢æŸ¥å›æ‡‰æ ¼å¼
            if (!response || !response.credential) {
                statusDiv.innerHTML = '<div class="error-message">ç™»å…¥å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</div>';
                console.error('ç„¡æ•ˆçš„ç™»å…¥å›æ‡‰:', response);
                return;
            }
            
            try {
                // åˆ†å‰² JWT tokenï¼ˆæ ¼å¼ï¼šheader.payload.signatureï¼‰
                const parts = response.credential.split('.');
                if (parts.length !== 3) {
                    throw new Error('JWT token æ ¼å¼éŒ¯èª¤');
                }
                
                // è§£ç¢¼ payloadï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰
                const decodedPayload = base64UrlDecode(parts[1]);
                const payload = JSON.parse(decodedPayload);
                
                console.log('è§£ç¢¼å¾Œçš„ payload:', payload);
                
                // é©—è­‰å¿…è¦çš„æ¬„ä½
                if (!payload.email) {
                    throw new Error('ç¼ºå°‘ email è³‡è¨Š');
                }
                
                // æ¸…é™¤æ‰€æœ‰èˆŠçš„ç™»å…¥è³‡è¨Šå’Œå¿«å–ï¼ˆç¢ºä¿å¯ä»¥åˆ‡æ›å¸³è™Ÿï¼‰
                // å¼·åˆ¶æ¸…é™¤æ‰€æœ‰ç›¸é—œçš„ localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('googleLogin') || key.includes('cache'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // æ¸…é™¤å®¢æˆ¶è³‡æ–™å¿«å–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (typeof window !== 'undefined' && typeof window.dataCache !== 'undefined') {
                    window.dataCache = null;
                }
                
                // æ¸…é™¤ç•¶å‰ä½¿ç”¨è€…å¿«å–
                if (typeof window !== 'undefined' && typeof window.currentUser !== 'undefined') {
                    window.currentUser = null;
                }
                
                // å„²å­˜æ–°çš„ç™»å…¥è³‡è¨Š
                const loginInfo = {
                    email: payload.email,
                    name: payload.name || payload.given_name || 'ä½¿ç”¨è€…',
                    picture: payload.picture || '',
                    googleId: payload.sub || '', // Google ä½¿ç”¨è€… ID
                    exp: Date.now() + (24 * 60 * 60 * 1000) // 24å°æ™‚å¾ŒéæœŸ
                };
                
                localStorage.setItem('googleLogin', JSON.stringify(loginInfo));
                
                // å¦‚æœä½¿ç”¨ Supabaseï¼Œå„²å­˜ä½¿ç”¨è€…åˆ°è³‡æ–™åº«
                if (typeof DATA_SOURCE !== 'undefined' && DATA_SOURCE === 'supabase' && typeof createOrUpdateUser !== 'undefined') {
                    try {
                        await createOrUpdateUser({
                            email: payload.email,
                            name: payload.name || payload.given_name || 'ä½¿ç”¨è€…',
                            picture: payload.picture || '',
                            googleId: payload.sub || ''
                        });
                        console.log('ä½¿ç”¨è€…è³‡æ–™å·²å„²å­˜åˆ° Supabase');
                    } catch (error) {
                        console.error('å„²å­˜ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
                        // å³ä½¿å„²å­˜å¤±æ•—ä¹Ÿç¹¼çºŒç™»å…¥æµç¨‹
                    }
                }
                
                statusDiv.innerHTML = '<div class="success-message">ç™»å…¥æˆåŠŸï¼æ­£åœ¨è·³è½‰...</div>';
                
                // éš±è—ç™»å‡ºæŒ‰éˆ•ï¼ˆå› ç‚ºè¦è·³è½‰äº†ï¼‰
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.style.display = 'none';
                }
                
                // è·³è½‰åˆ°ä¸»é é¢
                setTimeout(() => {
                    window.location.href = 'calendar.html';
                }, 1000);
            } catch (error) {
                statusDiv.innerHTML = '<div class="error-message">ç™»å…¥å¤±æ•—ï¼š' + error.message + '</div>';
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                console.error('å›æ‡‰å…§å®¹:', response);
            }
        }

        // åˆå§‹åŒ– Google Sign-In
        function initializeGoogleSignIn() {
            // æª¢æŸ¥ Client ID æ˜¯å¦å·²è¨­å®š
            if (typeof GOOGLE_CLIENT_ID === 'undefined' || !GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
                document.getElementById('loginStatus').innerHTML = 
                    '<div class="error-message">è«‹åœ¨ config.js ä¸­è¨­å®š GOOGLE_CLIENT_ID</div>';
                return;
            }

            // æ¸…é™¤ç¾æœ‰çš„æŒ‰éˆ•å…§å®¹
            const signinButton = document.getElementById('g_id_signin');
            if (signinButton) {
                signinButton.innerHTML = '';
            }

            // å¦‚æœ Google API å·²ç¶“è¼‰å…¥ï¼Œå…ˆæ¸…é™¤æ‰€æœ‰ç‹€æ…‹
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                try {
                    google.accounts.id.disableAutoSelect();
                    google.accounts.id.cancel();
                    google.accounts.id.storeCredential(null);
                } catch (e) {
                    console.log('æ¸…é™¤ Google ç‹€æ…‹:', e);
                }
            }

            // è¼‰å…¥ Google Sign-In è…³æœ¬ï¼ˆå¦‚æœå°šæœªè¼‰å…¥ï¼‰
            if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) {
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.async = true;
                script.defer = true;
                script.onload = function() {
                    initGoogleSignInButton();
                };
                script.onerror = function() {
                    console.error('ç„¡æ³•è¼‰å…¥ Google Sign-In è…³æœ¬');
                    document.getElementById('loginStatus').innerHTML = 
                        '<div class="error-message">ç„¡æ³•è¼‰å…¥ Google ç™»å…¥æœå‹™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>';
                };
                document.head.appendChild(script);
            } else {
                // å¦‚æœå·²ç¶“è¼‰å…¥ï¼Œç›´æ¥åˆå§‹åŒ–
                initGoogleSignInButton();
            }
        }

        // åˆå§‹åŒ– Google Sign-In æŒ‰éˆ•
        function initGoogleSignInButton() {
            if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) {
                console.error('Google Sign-In è…³æœ¬æœªæ­£ç¢ºè¼‰å…¥');
                return;
            }

            try {
                // å¼·åˆ¶æ¸…é™¤æ‰€æœ‰ç‹€æ…‹
                try {
                    google.accounts.id.disableAutoSelect();
                    google.accounts.id.cancel();
                    google.accounts.id.storeCredential(null);
                } catch (e) {
                    console.log('æ¸…é™¤ç‹€æ…‹æ™‚å‡ºéŒ¯:', e);
                }

                // ç”Ÿæˆéš¨æ©Ÿ nonce ä¾†å¼·åˆ¶æ–°çš„æœƒè©±
                const nonce = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                
                // åˆå§‹åŒ– Google Sign-In
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse,
                    auto_select: false, // ç¦ç”¨è‡ªå‹•é¸æ“‡å¸³è™Ÿ
                    cancel_on_tap_outside: true,
                    ux_mode: 'popup', // ä½¿ç”¨å½ˆå‡ºè¦–çª—æ¨¡å¼
                    itp_support: false,
                    use_fedcm_for_prompt: false,
                    nonce: nonce // ä½¿ç”¨ nonce å¼·åˆ¶æ–°çš„æœƒè©±
                });
                
                // æ¸²æŸ“ç™»å…¥æŒ‰éˆ•ï¼Œä½¿ç”¨ select_account æ¨¡å¼å¼·åˆ¶é¸æ“‡å¸³è™Ÿ
                const signinButton = document.getElementById('g_id_signin');
                if (signinButton) {
                    google.accounts.id.renderButton(signinButton, {
                        type: 'standard',
                        size: 'large',
                        theme: 'outline',
                        text: 'signin_with', // ä½¿ç”¨ signin_with è€Œä¸æ˜¯ sign_in_with
                        shape: 'rectangular',
                        logo_alignment: 'left',
                        context: 'signin',
                        ux_mode: 'popup',
                        // å¼·åˆ¶é¡¯ç¤ºå¸³è™Ÿé¸æ“‡
                        login_uri: window.location.origin + '/login.html'
                    });
                }
            } catch (error) {
                console.error('Google Sign-In åˆå§‹åŒ–éŒ¯èª¤:', error);
                document.getElementById('loginStatus').innerHTML = 
                    '<div class="error-message">åˆå§‹åŒ–ç™»å…¥åŠŸèƒ½å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            checkAndShowLogoutButton();
            // å»¶é²ä¸€é»æ™‚é–“ç¢ºä¿æ‰€æœ‰ç‹€æ…‹å·²æ¸…é™¤
            setTimeout(() => {
                initializeGoogleSignIn();
            }, 100);
        });
        
        // åœ¨é é¢å¯è¦‹æ™‚ä¹Ÿé‡æ–°åˆå§‹åŒ–ï¼ˆè™•ç†ç€è¦½å™¨è¿”å›çš„æƒ…æ³ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                setTimeout(() => {
                    clearGoogleSignInSession();
                    const signinButton = document.getElementById('g_id_signin');
                    if (signinButton && signinButton.innerHTML === '') {
                        initializeGoogleSignIn();
                    }
                }, 100);
            }
        });
    </script>
</body>
</html>

