<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 資料遷移工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #5568d3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-item {
            margin-bottom: 5px;
            padding: 5px;
        }
        .log-item.success {
            color: #28a745;
        }
        .log-item.error {
            color: #dc3545;
        }
        .log-item.info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Supabase 資料遷移工具</h1>
        <p>此工具將協助您將資料從 Google Sheets 遷移到 Supabase</p>
        
        <div class="form-group">
            <label for="supabaseUrl">Supabase Project URL</label>
            <input type="text" id="supabaseUrl" value="https://lvrcnmvnqbueghjyvxji.supabase.co" placeholder="https://your-project.supabase.co">
        </div>
        
        <div class="form-group">
            <label for="supabaseKey">Supabase Anon Key</label>
            <input type="text" id="supabaseKey" placeholder="請從 Supabase Dashboard > Settings > API 取得">
            <small style="color: #666;">請在 Supabase Dashboard > Settings > API 中複製 "anon/public" key</small>
        </div>
        
        <button onclick="startMigration()" id="migrateBtn">開始遷移</button>
        <button onclick="testConnection()" id="testBtn">測試連線</button>
        
        <div id="status" class="status"></div>
        <div id="log" class="log"></div>
    </div>

    <!-- 載入 Supabase JS 庫 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        let supabaseClient = null;
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');
        
        function log(message, type = 'info') {
            const item = document.createElement('div');
            item.className = `log-item ${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(item);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function showStatus(message, type) {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
        }
        
        function hideStatus() {
            statusElement.style.display = 'none';
        }
        
        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                showStatus('請填寫 Supabase URL 和 Key', 'error');
                return;
            }
            
            try {
                log('正在測試 Supabase 連線...', 'info');
                const client = supabase.createClient(url, key);
                
                // 測試查詢
                const { data, error } = await client.from('customers').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                log('✓ Supabase 連線成功！', 'success');
                showStatus('Supabase 連線成功！', 'success');
                supabaseClient = client;
            } catch (error) {
                log(`✗ 連線失敗: ${error.message}`, 'error');
                showStatus(`連線失敗: ${error.message}`, 'error');
            }
        }
        
        async function startMigration() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                showStatus('請填寫 Supabase URL 和 Key', 'error');
                return;
            }
            
            hideStatus();
            log('=== 開始資料遷移 ===', 'info');
            
            // 初始化 Supabase 客戶端
            if (!supabaseClient) {
                supabaseClient = supabase.createClient(url, key);
            }
            
            const migrateBtn = document.getElementById('migrateBtn');
            const testBtn = document.getElementById('testBtn');
            migrateBtn.disabled = true;
            testBtn.disabled = true;
            
            try {
                // 遷移客戶資料
                log('開始遷移客戶資料...', 'info');
                const customers = await fetchCustomers();
                if (customers.length > 0) {
                    await migrateCustomers(customers);
                    log(`✓ 客戶資料遷移完成，共 ${customers.length} 筆`, 'success');
                } else {
                    log('沒有客戶資料需要遷移', 'info');
                }
                
                // 遷移行程資料
                log('開始遷移行程資料...', 'info');
                const schedules = await fetchSchedules();
                if (schedules.length > 0) {
                    await migrateSchedules(schedules);
                    log(`✓ 行程資料遷移完成，共 ${schedules.length} 筆`, 'success');
                } else {
                    log('沒有行程資料需要遷移', 'info');
                }
                
                // 遷移訂單資料
                log('開始遷移訂單資料...', 'info');
                const orders = await fetchOrders();
                if (orders.length > 0) {
                    await migrateOrders(orders);
                    log(`✓ 訂單資料遷移完成，共 ${orders.length} 筆`, 'success');
                } else {
                    log('沒有訂單資料需要遷移', 'info');
                }
                
                log('=== 資料遷移完成 ===', 'success');
                showStatus('資料遷移完成！', 'success');
            } catch (error) {
                log(`✗ 遷移過程發生錯誤: ${error.message}`, 'error');
                showStatus(`遷移失敗: ${error.message}`, 'error');
            } finally {
                migrateBtn.disabled = false;
                testBtn.disabled = false;
            }
        }
        
        async function fetchCustomers() {
            const response = await fetch('https://script.google.com/macros/s/AKfycbzeAZjeeu-i_zxZ7yqtMhF-GlqRolONshl3DVckvv9jNxdWlvUSSnscDaAeVfLUQ7Ss/exec?action=getAll');
            const result = await response.json();
            return result.success ? result.data : [];
        }
        
        async function fetchSchedules() {
            const response = await fetch('https://script.google.com/macros/s/AKfycbzeAZjeeu-i_zxZ7yqtMhF-GlqRolONshl3DVckvv9jNxdWlvUSSnscDaAeVfLUQ7Ss/exec?action=getSchedules');
            const result = await response.json();
            return result.success ? result.data : [];
        }
        
        async function fetchOrders() {
            const response = await fetch('https://script.google.com/macros/s/AKfycbzeAZjeeu-i_zxZ7yqtMhF-GlqRolONshl3DVckvv9jNxdWlvUSSnscDaAeVfLUQ7Ss/exec?action=getOrders');
            const result = await response.json();
            return result.success ? result.data : [];
        }
        
        async function migrateCustomers(customers) {
            const customerData = customers.map(c => ({
                id: String(c.id),
                name: c.name || '',
                phone: c.phone || '',
                city: c.city || '',
                district: c.district || '',
                village: c.village || '',
                neighborhood: c.neighborhood || '',
                street_type: c.streetType || '',
                street_name: c.streetName || '',
                lane: c.lane || '',
                alley: c.alley || '',
                number: c.number || '',
                floor: c.floor || '',
                full_address: c.fullAddress || '',
                health_status: c.healthStatus || '',
                medications: c.medications || '',
                supplements: c.supplements || '',
                avatar: c.avatar || '',
                created_at: c.createdAt || new Date().toISOString()
            }));
            
            const batchSize = 100;
            for (let i = 0; i < customerData.length; i += batchSize) {
                const batch = customerData.slice(i, i + batchSize);
                const { error } = await supabaseClient
                    .from('customers')
                    .upsert(batch, { onConflict: 'id' });
                
                if (error) throw error;
                log(`  已遷移客戶資料批次 ${Math.floor(i / batchSize) + 1}/${Math.ceil(customerData.length / batchSize)}`, 'info');
            }
        }
        
        async function migrateSchedules(schedules) {
            const scheduleData = schedules.map(s => ({
                id: String(s.id),
                title: s.title || '',
                date: s.date || new Date().toISOString().split('T')[0],
                start_time: s.startTime || null,
                end_time: s.endTime || null,
                type: s.type || 'other',
                customer_id: s.customerId || null,
                notes: s.notes || ''
            }));
            
            const batchSize = 100;
            for (let i = 0; i < scheduleData.length; i += batchSize) {
                const batch = scheduleData.slice(i, i + batchSize);
                const { error } = await supabaseClient
                    .from('schedules')
                    .upsert(batch, { onConflict: 'id' });
                
                if (error) throw error;
                log(`  已遷移行程資料批次 ${Math.floor(i / batchSize) + 1}/${Math.ceil(scheduleData.length / batchSize)}`, 'info');
            }
        }
        
        async function migrateOrders(orders) {
            const orderData = orders.map(o => ({
                id: String(o.id),
                date: o.date || new Date().toISOString().split('T')[0],
                customer_id: o.customerId || null,
                product: o.product || '',
                quantity: o.quantity || 1,
                amount: o.amount || 0,
                paid: o.paid === true || o.paid === 'true',
                notes: o.notes || ''
            }));
            
            const batchSize = 100;
            for (let i = 0; i < orderData.length; i += batchSize) {
                const batch = orderData.slice(i, i + batchSize);
                const { error } = await supabaseClient
                    .from('orders')
                    .upsert(batch, { onConflict: 'id' });
                
                if (error) throw error;
                log(`  已遷移訂單資料批次 ${Math.floor(i / batchSize) + 1}/${Math.ceil(orderData.length / batchSize)}`, 'info');
            }
        }
    </script>
</body>
</html>

